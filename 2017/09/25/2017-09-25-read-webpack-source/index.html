<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> webpack源码阅读 · 小宋</title><meta name="description" content="webpack源码阅读 - rwson"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="小宋"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/rwson" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">webpack源码阅读</h1><div class="post-info">Sep 25, 2017</div><div class="post-content"><p>在前端工程化越来越普及的今天，我们几乎每个项目都需要用到构建工具，从一开始的<code>grunt</code>，到<code>gulp</code>，再到现在的<code>webpack</code>。<br>我们在使用<code>webpack</code>时，可以通过配置一些命令行参数来让<code>webpack</code>完成一些编译打包的任务，那么当我们执行<code>webpack</code>这个命令的时候，<code>webpack</code>究竟做了哪些事情? 我们一起来读读<code>webpack</code>的相关源码。</p>
<p>注：本文阅读的版本为<a href="https://github.com/webpack/webpack/tree/webpack-1" target="_blank" rel="external">webpack1.15.0</a>，从入口开始分析再拿到我们的命令之后执行的的流程，所以有些个人认为不重要的可能会省略。</p>
<p>通过<code>package.json</code>中的<code>bin</code>的指向可以知道首先会走到<code>./bin/webpack.js</code>这个文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env node</span></div><div class="line"></div><div class="line"><span class="comment">//	引入nodejs path模块</span></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"></div><div class="line"><span class="comment">// require.resolve获取/bin/webpack.js的绝对路径(从项目根目录下的node_modules里面找)</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">	<span class="keyword">var</span> localWebpack = <span class="built_in">require</span>.resolve(path.join(process.cwd(), <span class="string">"node_modules"</span>, <span class="string">"webpack"</span>, <span class="string">"bin"</span>, <span class="string">"webpack.js"</span>));</div><div class="line">	<span class="keyword">if</span>(__filename !== localWebpack) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="built_in">require</span>(localWebpack);</div><div class="line">	&#125;</div><div class="line">&#125; <span class="keyword">catch</span>(e) &#123;&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> optimist = <span class="built_in">require</span>(<span class="string">"optimist"</span>)</div><div class="line">	.usage(<span class="string">"webpack "</span> + <span class="built_in">require</span>(<span class="string">"../package.json"</span>).version + <span class="string">"\n"</span> +</div><div class="line">		<span class="string">"Usage: https://webpack.github.io/docs/cli.html"</span>);</div><div class="line"></div><div class="line"><span class="built_in">require</span>(<span class="string">"./config-optimist"</span>)(optimist);</div><div class="line"></div><div class="line"><span class="comment">//	对在命令行传入的参数进行解析</span></div><div class="line"><span class="comment">//	--colors、--json、 ...</span></div><div class="line">optimist</div><div class="line">	.boolean(<span class="string">"json"</span>).alias(<span class="string">"json"</span>, <span class="string">"j"</span>).describe(<span class="string">"json"</span>)</div><div class="line">	.boolean(<span class="string">"colors"</span>).alias(<span class="string">"colors"</span>, <span class="string">"c"</span>).describe(<span class="string">"colors"</span>)</div><div class="line">	<span class="comment">//	其他参数解析, 略;</span></div><div class="line"></div><div class="line"><span class="comment">//	获取解析后的参数并转换格式</span></div><div class="line"><span class="keyword">var</span> argv = optimist.argv;</div><div class="line"><span class="keyword">var</span> options = <span class="built_in">require</span>(<span class="string">"./convert-argv"</span>)(optimist, argv);</div><div class="line"></div><div class="line"><span class="comment">//	如果有符合argv里面的参数</span></div><div class="line"><span class="comment">//	就执行相关的回调函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ifArg</span>(<span class="params">name, fn, init</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(argv[name])) &#123;</div><div class="line">		<span class="keyword">if</span>(init) init();</div><div class="line">		argv[name].forEach(fn);</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> argv[name] !== <span class="string">"undefined"</span>) &#123;</div><div class="line">		<span class="keyword">if</span>(init) init();</div><div class="line">		fn(argv[name], <span class="number">-1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  处理输出相关（output）的配置参数，并执行编译函数</span></div><div class="line"><span class="comment"> *  @param   &#123;[type]&#125;  options  [description]</span></div><div class="line"><span class="comment"> *  @return  &#123;[type]&#125;           [description]</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">processOptions</span>(<span class="params">options</span>) </span>&#123;</div><div class="line">	<span class="comment">//	如果options下面的then是个函数(options是个Promise示例)</span></div><div class="line">	<span class="comment">//	把processOptions作为参数传到options.then中</span></div><div class="line">	<span class="comment">//	并且中断下面代码的执行</span></div><div class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span> options.then === <span class="string">"function"</span>) &#123;</div><div class="line">		options.then(processOptions).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">			<span class="built_in">console</span>.error(err.stack || err);</div><div class="line">			process.exit();</div><div class="line">		&#125;);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	如果传入的options是一个数组, 取数组的第一项</span></div><div class="line">	<span class="keyword">var</span> firstOptions = <span class="built_in">Array</span>.isArray(options) ? options[<span class="number">0</span>] : options;</div><div class="line"></div><div class="line">	<span class="comment">//	输出的配置</span></div><div class="line">	<span class="keyword">var</span> outputOptions = <span class="built_in">Object</span>.create(options.stats || firstOptions.stats || &#123;&#125;);</div><div class="line"></div><div class="line">	<span class="comment">//	如果outputOptions中本身没有context</span></div><div class="line">	<span class="comment">//	就把配置项中的context给它</span></div><div class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span> outputOptions.context === <span class="string">"undefined"</span>)</div><div class="line">		outputOptions.context = firstOptions.context;</div><div class="line"></div><div class="line">	<span class="comment">//	各种命令行参数处理</span></div><div class="line">	ifArg(<span class="string">"json"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">bool</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span>(bool)</div><div class="line">			outputOptions.json = bool;</div><div class="line">	&#125;);</div><div class="line">	<span class="comment">//	还有很多ifArg，略</span></div><div class="line"></div><div class="line">	<span class="comment">//	引入webpack入口文件</span></div><div class="line">	<span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">"../lib/webpack.js"</span>);</div><div class="line"></div><div class="line">	<span class="comment">//	错误堆栈追踪上限</span></div><div class="line">	<span class="built_in">Error</span>.stackTraceLimit = <span class="number">30</span>;</div><div class="line">	<span class="keyword">var</span> lastHash = <span class="literal">null</span>;</div><div class="line"></div><div class="line">	<span class="comment">//	执行编译</span></div><div class="line">	<span class="keyword">var</span> compiler = webpack(options);</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">compilerCallback</span>(<span class="params">err, stats</span>) </span>&#123;</div><div class="line">      	<span class="comment">//	命令行参数中没有带有--watch</span></div><div class="line">		<span class="keyword">if</span>(!options.watch) &#123;</div><div class="line">			compiler.purgeInputFileSystem();</div><div class="line">		&#125;</div><div class="line">      </div><div class="line">      	<span class="comment">//	出错</span></div><div class="line">		<span class="keyword">if</span>(err) &#123;</div><div class="line">			lastHash = <span class="literal">null</span>;</div><div class="line">			<span class="built_in">console</span>.error(err.stack || err);</div><div class="line">			<span class="keyword">if</span>(err.details) <span class="built_in">console</span>.error(err.details);</div><div class="line">			<span class="keyword">if</span>(!options.watch) &#123;</div><div class="line">				process.on(<span class="string">"exit"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">					process.exit(<span class="number">1</span>);</div><div class="line">				&#125;);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span>(outputOptions.json) &#123;</div><div class="line">			process.stdout.write(<span class="built_in">JSON</span>.stringify(stats.toJson(outputOptions), <span class="literal">null</span>, <span class="number">2</span>) + <span class="string">"\n"</span>);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(stats.hash !== lastHash) &#123;</div><div class="line">			lastHash = stats.hash;</div><div class="line">			process.stdout.write(stats.toString(outputOptions) + <span class="string">"\n"</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">  </div><div class="line">	<span class="comment">//	命令行参数中带有--watch</span></div><div class="line">	<span class="keyword">if</span>(options.watch) &#123;</div><div class="line">		<span class="keyword">var</span> primaryOptions = !<span class="built_in">Array</span>.isArray(options) ? options : options[<span class="number">0</span>];</div><div class="line">		<span class="keyword">var</span> watchOptions = primaryOptions.watchOptions || primaryOptions.watch || &#123;&#125;;</div><div class="line">		<span class="keyword">if</span>(watchOptions.stdin) &#123;</div><div class="line">			process.stdin.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">				process.exit(<span class="number">0</span>); <span class="comment">// eslint-disable-line</span></div><div class="line">			&#125;);</div><div class="line">			process.stdin.resume();</div><div class="line">		&#125;</div><div class="line">      	</div><div class="line">      	<span class="comment">//	调用compiler下面的watch来监听文件变化</span></div><div class="line">		compiler.watch(watchOptions, compilerCallback);</div><div class="line">	&#125; <span class="keyword">else</span></div><div class="line">		compiler.run(compilerCallback);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//	执行processOptions并且传入解析出来的参数</span></div><div class="line">processOptions(options);</div></pre></td></tr></table></figure>
<p>在上面定义的<code>processOptions</code>方法中可以看到引入了<code>../lib/webpack.js</code>这个文件，下面我们一起看看<code>../lib/webpack.js</code>这个文件。</p>
<p>在<code>../lib/webpack.js</code>中，<code>webpack</code>作为入口函数，我们一起看下它的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  webpack入口</span></div><div class="line"><span class="comment"> *  @param   &#123;Object&#125;    options   webpack.config.js中module.exports出来的对象</span></div><div class="line"><span class="comment"> *  @param   &#123;Function&#125;  callback  回调函数</span></div><div class="line"><span class="comment"> *  @return  &#123;Object&#125;              webpack Compiler Object/multi compiler object Collection</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">webpack</span>(<span class="params">options, callback</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> compiler;</div><div class="line">	<span class="comment">//	options是一个数组时, 实例化一个MultiCompiler, 去map这个数组, 针对每个配置项返回一个webpack实例, 最后用compiler接收</span></div><div class="line">	<span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(options)) &#123;</div><div class="line">		compiler = <span class="keyword">new</span> MultiCompiler(options.map(<span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</div><div class="line">			<span class="keyword">return</span> webpack(options);</div><div class="line">		&#125;));</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> options === <span class="string">"object"</span>) &#123;</div><div class="line">		</div><div class="line">		<span class="comment">// 实例化一个WebpackOptionsDefaulter来处理默认配置项</span></div><div class="line">		<span class="keyword">new</span> WebpackOptionsDefaulter().process(options);</div><div class="line"></div><div class="line">		<span class="comment">//	实例化一个Compiler, Compiler继承自Tapable(https://doc.webpack-china.org/api/plugins/tapable/)</span></div><div class="line">		<span class="comment">//	Compiler实例化后会继承到apply、plugin等调用和绑定插件的方法</span></div><div class="line">		compiler = <span class="keyword">new</span> Compiler();</div><div class="line"></div><div class="line">		<span class="comment">//	配置项</span></div><div class="line">		compiler.options = options;</div><div class="line"></div><div class="line">		<span class="comment">//	对传入的options进行逐个编译,并且把options作为返回值重赋值到compiler.options</span></div><div class="line">		compiler.options = <span class="keyword">new</span> WebpackOptionsApply().process(options, compiler);</div><div class="line"></div><div class="line">		<span class="comment">//	应用node环境插件(给compiler设置resolvers、watchFileSystem、outputFileSystem)</span></div><div class="line">		<span class="keyword">new</span> NodeEnvironmentPlugin().apply(compiler);</div><div class="line"></div><div class="line">		<span class="comment">//	触发environment和after-environment事件</span></div><div class="line">		compiler.applyPlugins(<span class="string">"environment"</span>);</div><div class="line">		compiler.applyPlugins(<span class="string">"after-environment"</span>);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">//	options既不是数组也不是对象时, 抛出异常</span></div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid argument: options"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	存在回调函数</span></div><div class="line">	<span class="keyword">if</span>(callback) &#123;</div><div class="line">		<span class="keyword">if</span>(<span class="keyword">typeof</span> callback !== <span class="string">"function"</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Invalid argument: callback"</span>);</div><div class="line"></div><div class="line">		<span class="comment">//	命令行里面带watch, 或者options是个数组(并且数组中有一项的watch为true)</span></div><div class="line">		<span class="keyword">if</span>(options.watch === <span class="literal">true</span> || (<span class="built_in">Array</span>.isArray(options) &amp;&amp;</div><div class="line">				options.some(<span class="function"><span class="keyword">function</span>(<span class="params">o</span>) </span>&#123;</div><div class="line">					<span class="keyword">return</span> o.watch;</div><div class="line">				&#125;))) &#123;</div><div class="line"></div><div class="line">			<span class="comment">//	根据参数类型拿到watchOptions</span></div><div class="line">			<span class="keyword">var</span> watchOptions = (!<span class="built_in">Array</span>.isArray(options) ? options : options[<span class="number">0</span>]).watchOptions || &#123;&#125;;</div><div class="line"></div><div class="line">			<span class="comment">//	watchDelay属性应该被options.watchOptions.aggregateTimeout代替</span></div><div class="line">			<span class="keyword">var</span> watchDelay = (!<span class="built_in">Array</span>.isArray(options) ? options : options[<span class="number">0</span>]).watchDelay;</div><div class="line">			<span class="keyword">if</span>(watchDelay) &#123;</div><div class="line">				<span class="built_in">console</span>.warn(<span class="string">"options.watchDelay is deprecated: Use 'options.watchOptions.aggregateTimeout' instead"</span>);</div><div class="line">				watchOptions.aggregateTimeout = watchDelay;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">//	实例化并返回一个watch对象</span></div><div class="line">			<span class="keyword">return</span> compiler.watch(watchOptions, callback);</div><div class="line">		&#125;</div><div class="line">		compiler.run(callback);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> compiler;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  在对象下用Object.defineProperty的方法添加插件</span></div><div class="line"><span class="comment"> *  @param   &#123;Object&#125;  exports  被添加的对象</span></div><div class="line"><span class="comment"> *  @param   &#123;String&#125;  path     在get中返回require</span></div><div class="line"><span class="comment"> *  @param   &#123;Array&#125;   plugins  插件数组</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">exportPlugins</span>(<span class="params">exports, path, plugins</span>) </span>&#123;</div><div class="line">	plugins.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</div><div class="line">		<span class="built_in">Object</span>.defineProperty(exports, name, &#123;</div><div class="line">			configurable: <span class="literal">false</span>,</div><div class="line">			enumerable: <span class="literal">true</span>,</div><div class="line">			get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">				<span class="keyword">return</span> <span class="built_in">require</span>(path + <span class="string">"/"</span> + name);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个文件最后，通过上面的<code>exportPlugins</code>在<code>webpack</code>下面挂载了一些插件做属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//	暴露插件到webpack下面</span></div><div class="line"><span class="comment">//	new webpack.DefinePlugin()</span></div><div class="line"><span class="comment">//	...</span></div><div class="line">exportPlugins(exports, <span class="string">"."</span>, [</div><div class="line">	<span class="string">"DefinePlugin"</span>,</div><div class="line">	<span class="comment">//	...</span></div><div class="line">]);</div><div class="line">exportPlugins(exports.optimize = &#123;&#125;, <span class="string">"./optimize"</span>, [</div><div class="line">	<span class="string">"AggressiveMergingPlugin"</span>,</div><div class="line">	<span class="string">"CommonsChunkPlugin"</span>,</div><div class="line">	<span class="string">"DedupePlugin"</span>,</div><div class="line">	<span class="string">"LimitChunkCountPlugin"</span>,</div><div class="line">	<span class="string">"MinChunkSizePlugin"</span>,</div><div class="line">	<span class="string">"OccurenceOrderPlugin"</span>,</div><div class="line">	<span class="string">"OccurrenceOrderPlugin"</span>,</div><div class="line">	<span class="string">"UglifyJsPlugin"</span></div><div class="line">]);</div><div class="line">exportPlugins(exports.dependencies = &#123;&#125;, <span class="string">"./dependencies"</span>, [</div><div class="line">	<span class="string">"LabeledModulesPlugin"</span></div><div class="line">]);</div></pre></td></tr></table></figure>
<p>刚才在对<code>webpack</code>进行标注的时候，实例化了<code>WebpackOptionsApply</code>对象并且调用了<code>process</code>方法，这个方法将会对我们传进去的<code>options</code>和<code>compiler</code>编译对象进行逐个编译，下面我们一起看下<code>WebpackOptionsApply</code>这个模块的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">WebpackOptionsApply</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">//	OptionsApply构造函数的继承</span></div><div class="line">	OptionsApply.call(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"><span class="built_in">module</span>.exports = WebpackOptionsApply;</div><div class="line"></div><div class="line"><span class="comment">//	继承OptionsApply的原型</span></div><div class="line">WebpackOptionsApply.prototype = <span class="built_in">Object</span>.create(OptionsApply.prototype);</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *  对我们传进去的options和compiler编译对象进行逐个编译</span></div><div class="line"><span class="comment"> *  @param   &#123;[type]&#125;  options   [description]</span></div><div class="line"><span class="comment"> *  @param   &#123;[type]&#125;  compiler  [description]</span></div><div class="line"><span class="comment"> *  @return  &#123;[type]&#125;            [description]</span></div><div class="line"><span class="comment"> */</span></div><div class="line">WebpackOptionsApply.prototype.process = <span class="function"><span class="keyword">function</span>(<span class="params">options, compiler</span>) </span>&#123;</div><div class="line">	<span class="comment">//	context处理</span></div><div class="line">	compiler.context = options.context;</div><div class="line"></div><div class="line">	<span class="comment">//	plugins的处理, 调用compiler.apply.apply</span></div><div class="line">	<span class="keyword">if</span>(options.plugins &amp;&amp; <span class="built_in">Array</span>.isArray(options.plugins)) &#123;</div><div class="line">		compiler.apply.apply(compiler, options.plugins);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	缓存输入输出的路径</span></div><div class="line">	compiler.outputPath = options.output.path;</div><div class="line">	compiler.recordsInputPath = options.recordsInputPath || options.recordsPath;</div><div class="line">	compiler.recordsOutputPath = options.recordsOutputPath || options.recordsPath;</div><div class="line">	compiler.name = options.name;</div><div class="line"></div><div class="line">	<span class="comment">//	如果options.target是个字符串,根据options.target判断具体应用哪些插件(compiler.apply)</span></div><div class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span> options.target === <span class="string">"string"</span>) &#123;</div><div class="line">		<span class="comment">//	这边本来有个switch...case来根据options.target的具体值应用</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(options.target !== <span class="literal">false</span>) &#123;</div><div class="line">		options.target(compiler);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Unsupported target '"</span> + options.target + <span class="string">"'."</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	output.library相关配置</span></div><div class="line">	<span class="keyword">if</span>(options.output.library || options.output.libraryTarget !== <span class="string">"var"</span>) &#123;</div><div class="line">		<span class="keyword">var</span> LibraryTemplatePlugin = <span class="built_in">require</span>(<span class="string">"./LibraryTemplatePlugin"</span>);</div><div class="line">		compiler.apply(<span class="keyword">new</span> LibraryTemplatePlugin(options.output.library, options.output.libraryTarget, options.output.umdNamedDefine));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	处理externals属性,告诉webpack不要打包这些模块,而是在运行时从环境中请求他们</span></div><div class="line">	<span class="keyword">if</span>(options.externals) &#123;</div><div class="line">		<span class="keyword">var</span> ExternalsPlugin = <span class="built_in">require</span>(<span class="string">"./ExternalsPlugin"</span>);</div><div class="line">		compiler.apply(<span class="keyword">new</span> ExternalsPlugin(options.output.libraryTarget, options.externals));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	处理hot属性,devServer相关</span></div><div class="line">	<span class="keyword">if</span>(options.hot) &#123;</div><div class="line">		compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"hot"</span>, <span class="string">"HotModuleReplacementPlugin"</span>));</div><div class="line">		<span class="keyword">var</span> HotModuleReplacementPlugin = <span class="built_in">require</span>(<span class="string">"./HotModuleReplacementPlugin"</span>);</div><div class="line">		compiler.apply(<span class="keyword">new</span> HotModuleReplacementPlugin(options.output));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	devtool和sourceMap相关配置</span></div><div class="line">	<span class="keyword">if</span>(options.devtool &amp;&amp; (options.devtool.indexOf(<span class="string">"sourcemap"</span>) &gt;= <span class="number">0</span> || options.devtool.indexOf(<span class="string">"source-map"</span>) &gt;= <span class="number">0</span>)) &#123;</div><div class="line">		<span class="keyword">var</span> hidden = options.devtool.indexOf(<span class="string">"hidden"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> inline = options.devtool.indexOf(<span class="string">"inline"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> evalWrapped = options.devtool.indexOf(<span class="string">"eval"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> cheap = options.devtool.indexOf(<span class="string">"cheap"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> moduleMaps = options.devtool.indexOf(<span class="string">"module"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> noSources = options.devtool.indexOf(<span class="string">"nosources"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> legacy = options.devtool.indexOf(<span class="string">"@"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> modern = options.devtool.indexOf(<span class="string">"#"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> comment = legacy &amp;&amp; modern ? <span class="string">"\n/*\n//@ sourceMappingURL=[url]\n//# sourceMappingURL=[url]\n*/"</span> :</div><div class="line">			legacy ? <span class="string">"\n/*\n//@ sourceMappingURL=[url]\n*/"</span> :</div><div class="line">			modern ? <span class="string">"\n//# sourceMappingURL=[url]"</span> :</div><div class="line">			<span class="literal">null</span>;</div><div class="line">		<span class="keyword">var</span> Plugin = evalWrapped ? EvalSourceMapDevToolPlugin : SourceMapDevToolPlugin;</div><div class="line">		compiler.apply(<span class="keyword">new</span> Plugin(&#123;</div><div class="line">			filename: inline ? <span class="literal">null</span> : options.output.sourceMapFilename,</div><div class="line">			moduleFilenameTemplate: options.output.devtoolModuleFilenameTemplate,</div><div class="line">			fallbackModuleFilenameTemplate: options.output.devtoolFallbackModuleFilenameTemplate,</div><div class="line">			append: hidden ? <span class="literal">false</span> : comment,</div><div class="line">			<span class="built_in">module</span>: moduleMaps ? <span class="literal">true</span> : cheap ? <span class="literal">false</span> : <span class="literal">true</span>,</div><div class="line">			columns: cheap ? <span class="literal">false</span> : <span class="literal">true</span>,</div><div class="line">			lineToLine: options.output.devtoolLineToLine,</div><div class="line">			noSources: noSources,</div><div class="line">		&#125;));</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(options.devtool &amp;&amp; options.devtool.indexOf(<span class="string">"eval"</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">var</span> legacy = options.devtool.indexOf(<span class="string">"@"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> modern = options.devtool.indexOf(<span class="string">"#"</span>) &gt;= <span class="number">0</span>;</div><div class="line">		<span class="keyword">var</span> comment = legacy &amp;&amp; modern ? <span class="string">"//@ sourceURL=[url]\n//# sourceURL=[url]"</span> :</div><div class="line">			legacy ? <span class="string">"//@ sourceURL=[url]"</span> :</div><div class="line">			modern ? <span class="string">"//# sourceURL=[url]"</span> :</div><div class="line">			<span class="literal">null</span>;</div><div class="line">		compiler.apply(<span class="keyword">new</span> EvalDevToolModulePlugin(comment, options.output.devtoolModuleFilenameTemplate));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	compiler.apply(<span class="keyword">new</span> EntryOptionPlugin());</div><div class="line">	compiler.applyPluginsBailResult(<span class="string">"entry-option"</span>, options.context, options.entry);</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(options.prefetch) &#123;</div><div class="line">		compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"prefetch"</span>, <span class="string">"PrefetchPlugin"</span>));</div><div class="line">		<span class="keyword">var</span> PrefetchPlugin = <span class="built_in">require</span>(<span class="string">"./PrefetchPlugin"</span>);</div><div class="line">		options.prefetch.map(<span class="function"><span class="keyword">function</span>(<span class="params">request</span>) </span>&#123;</div><div class="line">			compiler.apply(<span class="keyword">new</span> PrefetchPlugin(options.context, request));</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">	compiler.apply(</div><div class="line">		<span class="keyword">new</span> CompatibilityPlugin(),</div><div class="line">		<span class="keyword">new</span> LoaderPlugin(),						<span class="comment">//	loader插件</span></div><div class="line">		<span class="keyword">new</span> NodeStuffPlugin(options.node),		<span class="comment">//	nodejs环境相关的插件</span></div><div class="line">		<span class="keyword">new</span> RequireJsStuffPlugin(),				<span class="comment">//	RequireJs的插件</span></div><div class="line">		<span class="keyword">new</span> APIPlugin(),						<span class="comment">//	变量名的替换,编译后的文件里随处可见的__webpack_require__变量名就是在此处理</span></div><div class="line">		<span class="keyword">new</span> ConstPlugin(),						<span class="comment">//	转换一些if, 三目表达式等等</span></div><div class="line">		<span class="keyword">new</span> RequireIncludePlugin(),				<span class="comment">//	require.include函数的转换</span></div><div class="line">		<span class="keyword">new</span> RequireEnsurePlugin(),				<span class="comment">//	require.ensure函数的转换</span></div><div class="line">		<span class="keyword">new</span> RequireContextPlugin(options.resolve.modulesDirectories, options.resolve.extensions),</div><div class="line">												<span class="comment">//	</span></div><div class="line">		<span class="keyword">new</span> AMDPlugin(options.module, options.amd || &#123;&#125;),</div><div class="line">												<span class="comment">//	AMD规范插件</span></div><div class="line">		<span class="keyword">new</span> CommonJsPlugin(options.module)		<span class="comment">//	commonJs规范插件</span></div><div class="line">	);</div><div class="line"></div><div class="line">	compiler.apply(</div><div class="line">		<span class="keyword">new</span> RemoveParentModulesPlugin(),		<span class="comment">//	移除父module的插件</span></div><div class="line">		<span class="keyword">new</span> RemoveEmptyChunksPlugin(),			<span class="comment">//	移除空模块的插件</span></div><div class="line">		<span class="keyword">new</span> MergeDuplicateChunksPlugin(),		<span class="comment">//	移除重复模块的插件</span></div><div class="line">		<span class="keyword">new</span> FlagIncludedChunksPlugin()			<span class="comment">//	output中对于名称的配置([name].[hash].[ext])</span></div><div class="line">	);</div><div class="line"></div><div class="line">	compiler.apply(<span class="keyword">new</span> TemplatedPathPlugin());</div><div class="line"></div><div class="line">	compiler.apply(<span class="keyword">new</span> RecordIdsPlugin());		<span class="comment">//	记录chunkId的插件</span></div><div class="line"></div><div class="line">	compiler.apply(<span class="keyword">new</span> WarnCaseSensitiveModulesPlugin());</div><div class="line">												<span class="comment">//	大小写敏感的插件</span></div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * webpack.optimize属性下的几个方法</span></div><div class="line"><span class="comment">	 * ./webpack.js</span></div><div class="line"><span class="comment">	 * exportPlugins(exports.optimize = &#123;&#125;, "./optimize", [</span></div><div class="line"><span class="comment">	 * 		"AggressiveMergingPlugin"</span></div><div class="line"><span class="comment">	 * 		//	...</span></div><div class="line"><span class="comment">	 * ]);</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="keyword">if</span>(options.optimize &amp;&amp; options.optimize.occurenceOrder) &#123;</div><div class="line">		compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.occurenceOrder"</span>, <span class="string">"optimize.OccurrenceOrderPlugin"</span>));</div><div class="line">		<span class="keyword">var</span> OccurrenceOrderPlugin = <span class="built_in">require</span>(<span class="string">"./optimize/OccurrenceOrderPlugin"</span>);</div><div class="line">		compiler.apply(<span class="keyword">new</span> OccurrenceOrderPlugin(options.optimize.occurenceOrderPreferEntry));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 处理minChunkSize, 性能优化相关</span></div><div class="line"><span class="comment">	 * 一些小模块会被打包成单独的模块而造成不必要的HTTP请求, 指定minChunkSize会合并这些小模块, 减少HTTP请求</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="keyword">if</span>(options.optimize &amp;&amp; options.optimize.minChunkSize) &#123;</div><div class="line">		compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.minChunkSize"</span>, <span class="string">"optimize.MinChunkSizePlugin"</span>));</div><div class="line">		<span class="keyword">var</span> MinChunkSizePlugin = <span class="built_in">require</span>(<span class="string">"./optimize/MinChunkSizePlugin"</span>);</div><div class="line">		compiler.apply(<span class="keyword">new</span> MinChunkSizePlugin(options.optimize));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	和maxChunksSize相反</span></div><div class="line">	<span class="keyword">if</span>(options.optimize &amp;&amp; options.optimize.maxChunks) &#123;</div><div class="line">		compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.maxChunks"</span>, <span class="string">"optimize.LimitChunkCountPlugin"</span>));</div><div class="line">		<span class="keyword">var</span> LimitChunkCountPlugin = <span class="built_in">require</span>(<span class="string">"./optimize/LimitChunkCountPlugin"</span>);</div><div class="line">		compiler.apply(<span class="keyword">new</span> LimitChunkCountPlugin(options.optimize));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(options.optimize.minimize) &#123;</div><div class="line">		compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"optimize.minimize"</span>, <span class="string">"optimize.UglifyJsPlugin"</span>));</div><div class="line">		<span class="keyword">var</span> UglifyJsPlugin = <span class="built_in">require</span>(<span class="string">"./optimize/UglifyJsPlugin"</span>);</div><div class="line">		<span class="keyword">if</span>(options.optimize.minimize === <span class="literal">true</span>)</div><div class="line">			compiler.apply(<span class="keyword">new</span> UglifyJsPlugin());</div><div class="line">		<span class="keyword">else</span></div><div class="line">			compiler.apply(<span class="keyword">new</span> UglifyJsPlugin(options.optimize.minimize));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	缓存,该属性在watch的模式下默认开启缓存</span></div><div class="line">	<span class="keyword">if</span>(options.cache === <span class="literal">undefined</span> ? options.watch : options.cache) &#123;</div><div class="line">		<span class="keyword">var</span> CachePlugin = <span class="built_in">require</span>(<span class="string">"./CachePlugin"</span>);</div><div class="line">		compiler.apply(<span class="keyword">new</span> CachePlugin(<span class="keyword">typeof</span> options.cache === <span class="string">"object"</span> ? options.cache : <span class="literal">null</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 处理provide属性,如果有则调用ProvidePlugin插件,这个插件可以让一个module赋值为一个变量,从而能在每个module中以变量名访问它</span></div><div class="line"><span class="comment">	 * new webpack.ProvidePlugin(&#123;</span></div><div class="line"><span class="comment">	 * 		identifier: "module1"</span></div><div class="line"><span class="comment">	 * &#125;);</span></div><div class="line"><span class="comment">	 * new webpack.ProvidePlugin(&#123;</span></div><div class="line"><span class="comment">	 * 		identifier: ["module1", "property1"]</span></div><div class="line"><span class="comment">	 * &#125;);</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span> options.provide === <span class="string">"object"</span>) &#123;</div><div class="line">		compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"provide"</span>, <span class="string">"ProvidePlugin"</span>));</div><div class="line">		<span class="keyword">var</span> ProvidePlugin = <span class="built_in">require</span>(<span class="string">"./ProvidePlugin"</span>);</div><div class="line">		compiler.apply(<span class="keyword">new</span> ProvidePlugin(options.provide));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line"><span class="comment">	 * 处理define属性,如果有这个属性则调用DefinePlugin插件,这个插件可以定义全局的常量</span></div><div class="line"><span class="comment">	 * //	define</span></div><div class="line"><span class="comment">	 * new webpack.DefinePlugin(&#123;</span></div><div class="line"><span class="comment">	 * 		PRODUCTION: JSON.stringify(true),</span></div><div class="line"><span class="comment">	 * 		BROWSER_SUPPORTS_HTML5: true</span></div><div class="line"><span class="comment">	 * &#125;);</span></div><div class="line"><span class="comment">	 *</span></div><div class="line"><span class="comment">	 * //	use</span></div><div class="line"><span class="comment">	 * if(!PRODUCTION) &#123;</span></div><div class="line"><span class="comment">	 * 		console.log("develop mode");</span></div><div class="line"><span class="comment">	 * &#125;</span></div><div class="line"><span class="comment">	 *</span></div><div class="line"><span class="comment">	 * if (!BROWSER_SUPPORTS_HTML5) &#123;</span></div><div class="line"><span class="comment">	 * 		require("html5shiv");</span></div><div class="line"><span class="comment">	 * &#125; </span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="keyword">if</span>(options.define) &#123;</div><div class="line">		compiler.apply(<span class="keyword">new</span> MovedToPluginWarningPlugin(<span class="string">"define"</span>, <span class="string">"DefinePlugin"</span>));</div><div class="line">		<span class="keyword">var</span> defineObject = &#123;&#125;;</div><div class="line">		<span class="keyword">if</span>(<span class="keyword">typeof</span> options.define === <span class="string">"object"</span>) &#123;</div><div class="line">			<span class="built_in">Object</span>.keys(options.define).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</div><div class="line">				defineObject[key] = options.define[key];</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line">		compiler.apply(<span class="keyword">new</span> DefinePlugin(defineObject));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//	defineDebug不为false,声明一个全局的DEBUG</span></div><div class="line">	<span class="keyword">if</span>(options.defineDebug !== <span class="literal">false</span>)</div><div class="line">		compiler.apply(<span class="keyword">new</span> DefinePlugin(&#123;</div><div class="line">			DEBUG: !!options.debug</div><div class="line">		&#125;));</div><div class="line"></div><div class="line">	<span class="comment">//	触发after-plugins和应用一些其他插件, 最后触发after-resolvers</span></div><div class="line">	compiler.applyPlugins(<span class="string">"after-plugins"</span>, compiler);</div><div class="line">	compiler.resolvers.normal.apply(</div><div class="line">		<span class="keyword">new</span> UnsafeCachePlugin(options.resolve.unsafeCache)</div><div class="line">		<span class="comment">//	...</span></div><div class="line">	);</div><div class="line">	<span class="comment">//	...</span></div><div class="line">	compiler.applyPlugins(<span class="string">"after-resolvers"</span>, compiler);</div><div class="line"></div><div class="line">	<span class="comment">//	返回options</span></div><div class="line">	<span class="keyword">return</span> options;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>看完这一段之后，个人对<code>webpack</code>的了解更深入了一些，熟悉了好几个平常不怎么用到，但是感觉还是很有用的东西，例如<code>externals</code>和<code>define</code>属性。</p>
<p>到这里，<code>webpack</code>的整体流程算是完了，在<code>webpack</code>中，有各式各样的插件，下面我们一起了解下大家所熟知的<code>UglifyJsPlugin</code>来理解下插件体系和加深对<code>webpack</code>流程的理解。</p>
<p>首先我们了解下开发<a href="https://doc.webpack-china.org/development/how-to-write-a-plugin" target="_blank" rel="external">webpack插件</a>的一些事项：<br>在中文里面提到：</p>
<ul>
<li>一个JavaScript命名函数</li>
<li>在它的原型上定义一个<code>apply</code>方法</li>
<li>指定挂载的webpack事件钩子</li>
<li>处理webpack内部实例的特定数据</li>
<li>功能完成后调用webpack提供的回调</li>
</ul>
<p>基础结构如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 命名函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyExampleWebpackPlugin</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">//	...</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 在它的 prototype 上定义一个 apply 方法。</span></div><div class="line">MyExampleWebpackPlugin.prototype.apply = <span class="function"><span class="keyword">function</span>(<span class="params">compiler</span>) </span>&#123;</div><div class="line">  <span class="comment">// 指定挂载的webpack事件钩子</span></div><div class="line">  compiler.plugin(<span class="string">'webpacksEventHook'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">compilation <span class="regexp">/* 处理webpack内部实例的特定数据*/</span>, callback</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"This is an example plugin!!!"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 功能完成后调用webpack提供的回调。</span></div><div class="line">    callback();</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>了解了插件的基本架构，下面一起看下<code>UglifyJsPlugin</code>的实现，<code>UglifyJsPlugin</code>位于<code>lib/optimize/UglifyJsPlugin.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//	一个JavaScript命名函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">UglifyJsPlugin</span>(<span class="params">options</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span> options !== <span class="string">"object"</span>) options = &#123;&#125;;</div><div class="line">	<span class="keyword">if</span>(<span class="keyword">typeof</span> options.compressor !== <span class="string">"undefined"</span>) &#123;</div><div class="line">		options.compress = options.compressor;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">this</span>.options = options;</div><div class="line">&#125;</div><div class="line"><span class="built_in">module</span>.exports = UglifyJsPlugin;</div><div class="line"></div><div class="line"><span class="comment">//	在它的原型上定义一个apply方法</span></div><div class="line">UglifyJsPlugin.prototype.apply = <span class="function"><span class="keyword">function</span>(<span class="params">compiler</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> options = <span class="keyword">this</span>.options;</div><div class="line"></div><div class="line">	<span class="comment">//	如果只选指定项中有关于文件后缀的就用指定项中的，否则用默认的(.js结尾)</span></div><div class="line">	options.test = options.test || <span class="regexp">/\.js($|\?)/i</span>;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> requestShortener = <span class="keyword">new</span> RequestShortener(compiler.context);</div><div class="line">	compiler.plugin(<span class="string">"compilation"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">compilation</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span>(options.sourceMap !== <span class="literal">false</span>) &#123;</div><div class="line">			compilation.plugin(<span class="string">"build-module"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">module</span>) </span>&#123;</div><div class="line">				<span class="comment">// to get detailed location info about errors</span></div><div class="line">				<span class="built_in">module</span>.useSourceMap = <span class="literal">true</span>;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">/**</span></div><div class="line"><span class="comment">		 * 指定挂载的webpack事件钩子(optimize-chunk-assets)</span></div><div class="line"><span class="comment">		 * @param  &#123;Object&#125;  chunks     被压缩的模块信息</span></div><div class="line"><span class="comment">		 * @param  &#123;Object&#125;  callback 	webpack提供的回调</span></div><div class="line"><span class="comment">		 */</span></div><div class="line">		compilation.plugin(<span class="string">"optimize-chunk-assets"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunks, callback</span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> files = [];</div><div class="line"></div><div class="line">			<span class="comment">//	取出模块中的文件</span></div><div class="line">			chunks.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">				chunk.files.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</div><div class="line">					files.push(file);</div><div class="line">				&#125;);</div><div class="line">			&#125;);</div><div class="line"></div><div class="line">			<span class="comment">//	compilation.additionalChunkAssets这个队列在lib/HotModuleReplacementPlugin.js这个文件中被加入了新元素</span></div><div class="line">			<span class="comment">//	也一起合并到files中去</span></div><div class="line">			compilation.additionalChunkAssets.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</div><div class="line">				files.push(file);</div><div class="line">			&#125;);</div><div class="line"></div><div class="line">			<span class="comment">//	提取出符合options中指定的文件后缀的文件</span></div><div class="line">			files = files.filter(ModuleFilenameHelpers.matchObject.bind(<span class="literal">undefined</span>, options));</div><div class="line">			files.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</div><div class="line">				<span class="keyword">var</span> oldWarnFunction = uglify.AST_Node.warn_function;</div><div class="line">				<span class="keyword">var</span> warnings = [];</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					<span class="keyword">var</span> asset = compilation.assets[file];</div><div class="line">					<span class="keyword">if</span>(asset.__UglifyJsPlugin) &#123;</div><div class="line">						compilation.assets[file] = asset.__UglifyJsPlugin;</div><div class="line">						<span class="keyword">return</span>;</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="comment">//	sourceMap相关</span></div><div class="line">					<span class="keyword">if</span>(options.sourceMap !== <span class="literal">false</span>) &#123;</div><div class="line">						<span class="keyword">if</span>(asset.sourceAndMap) &#123;</div><div class="line">							<span class="keyword">var</span> sourceAndMap = asset.sourceAndMap();</div><div class="line">							<span class="keyword">var</span> inputSourceMap = sourceAndMap.map;</div><div class="line">							<span class="keyword">var</span> input = sourceAndMap.source;</div><div class="line">						&#125; <span class="keyword">else</span> &#123;</div><div class="line">							<span class="keyword">var</span> inputSourceMap = asset.map();</div><div class="line">							<span class="keyword">var</span> input = asset.source();</div><div class="line">						&#125;</div><div class="line">						<span class="keyword">var</span> sourceMap = <span class="keyword">new</span> SourceMapConsumer(inputSourceMap);</div><div class="line">						uglify.AST_Node.warn_function = <span class="function"><span class="keyword">function</span>(<span class="params">warning</span>) </span>&#123; <span class="comment">// eslint-disable-line camelcase</span></div><div class="line">							<span class="keyword">var</span> match = <span class="regexp">/\[.+:([0-9]+),([0-9]+)\]/</span>.exec(warning);</div><div class="line">							<span class="keyword">var</span> line = +match[<span class="number">1</span>];</div><div class="line">							<span class="keyword">var</span> column = +match[<span class="number">2</span>];</div><div class="line">							<span class="keyword">var</span> original = sourceMap.originalPositionFor(&#123;</div><div class="line">								line: line,</div><div class="line">								column: column</div><div class="line">							&#125;);</div><div class="line">							<span class="keyword">if</span>(!original || !original.source || original.source === file) <span class="keyword">return</span>;</div><div class="line">							warnings.push(warning.replace(<span class="regexp">/\[.+:([0-9]+),([0-9]+)\]/</span>, <span class="string">""</span>) +</div><div class="line">								<span class="string">"["</span> + requestShortener.shorten(original.source) + <span class="string">":"</span> + original.line + <span class="string">","</span> + original.column + <span class="string">"]"</span>);</div><div class="line">						&#125;;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						<span class="keyword">var</span> input = asset.source();</div><div class="line">						uglify.AST_Node.warn_function = <span class="function"><span class="keyword">function</span>(<span class="params">warning</span>) </span>&#123; <span class="comment">// eslint-disable-line camelcase</span></div><div class="line">							warnings.push(warning);</div><div class="line">						&#125;;</div><div class="line">					&#125;</div><div class="line">					uglify.base54.reset();</div><div class="line">					<span class="keyword">var</span> ast = uglify.parse(input, &#123;</div><div class="line">						filename: file</div><div class="line">					&#125;);</div><div class="line"></div><div class="line">					<span class="comment">//	压缩代码并应用转换</span></div><div class="line">					<span class="keyword">if</span>(options.compress !== <span class="literal">false</span>) &#123;</div><div class="line">						ast.figure_out_scope();</div><div class="line">						<span class="keyword">var</span> compress = uglify.Compressor(options.compress);</div><div class="line">						ast = ast.transform(compress);</div><div class="line">					&#125;</div><div class="line"></div><div class="line">					<span class="comment">//	在顶级作用域打乱变量名称（默认不开启）</span></div><div class="line">					<span class="keyword">if</span>(options.mangle !== <span class="literal">false</span>) &#123;</div><div class="line">						ast.figure_out_scope(options.mangle || &#123;&#125;);</div><div class="line">						ast.compute_char_frequency(options.mangle || &#123;&#125;);</div><div class="line">						ast.mangle_names(options.mangle || &#123;&#125;);</div><div class="line">						<span class="keyword">if</span>(options.mangle &amp;&amp; options.mangle.props) &#123;</div><div class="line">							uglify.mangle_properties(ast, options.mangle.props);</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">var</span> output = &#123;&#125;;</div><div class="line"></div><div class="line">					<span class="comment">//	注释</span></div><div class="line">					output.comments = <span class="built_in">Object</span>.prototype.hasOwnProperty.call(options, <span class="string">"comments"</span>) ? options.comments : <span class="regexp">/^\**!|@preserve|@license/</span>;</div><div class="line"></div><div class="line">					<span class="comment">//	代码美化</span></div><div class="line">					output.beautify = options.beautify;</div><div class="line"></div><div class="line">					<span class="comment">//	把options.output下的每项提取到output</span></div><div class="line">					<span class="keyword">for</span>(<span class="keyword">var</span> k <span class="keyword">in</span> options.output) &#123;</div><div class="line">						output[k] = options.output[k];</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">if</span>(options.sourceMap !== <span class="literal">false</span>) &#123;</div><div class="line">						<span class="keyword">var</span> map = uglify.SourceMap(&#123; <span class="comment">// eslint-disable-line new-cap</span></div><div class="line">							file: file,</div><div class="line">							root: <span class="string">""</span></div><div class="line">						&#125;);</div><div class="line">						output.source_map = map; <span class="comment">// eslint-disable-line camelcase</span></div><div class="line">					&#125;</div><div class="line">					<span class="keyword">var</span> stream = uglify.OutputStream(output); <span class="comment">// eslint-disable-line new-cap</span></div><div class="line">					ast.print(stream);</div><div class="line">					<span class="keyword">if</span>(map) map = map + <span class="string">""</span>;</div><div class="line">					stream = stream + <span class="string">""</span>;</div><div class="line">					asset.__UglifyJsPlugin = compilation.assets[file] = (map ?</div><div class="line">						<span class="keyword">new</span> SourceMapSource(stream, file, <span class="built_in">JSON</span>.parse(map), input, inputSourceMap) :</div><div class="line">						<span class="keyword">new</span> RawSource(stream));</div><div class="line">					<span class="keyword">if</span>(warnings.length &gt; <span class="number">0</span>) &#123;</div><div class="line">						compilation.warnings.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + warnings.join(<span class="string">"\n"</span>)));</div><div class="line">					&#125;</div><div class="line">				&#125; <span class="keyword">catch</span>(err) &#123;</div><div class="line">					<span class="comment">//	捕获到压缩出错信息的操作</span></div><div class="line">					<span class="keyword">if</span>(err.line) &#123;</div><div class="line">						<span class="keyword">var</span> original = sourceMap &amp;&amp; sourceMap.originalPositionFor(&#123;</div><div class="line">							line: err.line,</div><div class="line">							column: err.col</div><div class="line">						&#125;);</div><div class="line">						<span class="keyword">if</span>(original &amp;&amp; original.source) &#123;</div><div class="line">							compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.message + <span class="string">" ["</span> + requestShortener.shorten(original.source) + <span class="string">":"</span> + original.line + <span class="string">","</span> + original.column + <span class="string">"]"</span>));</div><div class="line">						&#125; <span class="keyword">else</span> &#123;</div><div class="line">							compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.message + <span class="string">" ["</span> + file + <span class="string">":"</span> + err.line + <span class="string">","</span> + err.col + <span class="string">"]"</span>));</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span>(err.msg) &#123;</div><div class="line">						compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.msg));</div><div class="line">					&#125; <span class="keyword">else</span></div><div class="line">						compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(file + <span class="string">" from UglifyJs\n"</span> + err.stack));</div><div class="line">				&#125; <span class="keyword">finally</span> &#123;</div><div class="line">					uglify.AST_Node.warn_function = oldWarnFunction; <span class="comment">// eslint-disable-line camelcase</span></div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line"></div><div class="line">			<span class="comment">//	执行回调函数</span></div><div class="line">			callback();</div><div class="line">		&#125;);</div><div class="line"></div><div class="line">		<span class="comment">// 指定挂载的webpack事件钩子(normal-module-loader)</span></div><div class="line">		compilation.plugin(<span class="string">"normal-module-loader"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">context</span>) </span>&#123;</div><div class="line">			context.minimize = <span class="literal">true</span>;</div><div class="line">		&#125;);</div><div class="line">	&#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>上面就是我对<code>UglifyJsPlugin</code>的标注，从这个插件的源码分析，我们可以基本看到 webpack 编译时的读写过程大致是怎么样的：实例化插件 –&gt; 读取源文件 –&gt; 编译并输出</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>我们在命令行里输入了<code>webpack [--xxx]</code>之后，<code>webpack</code>内部大概帮我们做了下面几件事情：</p>
<ul>
<li>首先会走到<code>bin/webpack.js</code>，解析命令行参数以及开始执行编译</li>
<li>在<code>bin/webpack.js</code>中调用<code>webpack</code>入口函数， 走到<code>lib/webpack.js</code></li>
<li>在<code>webpack</code>中实例化一个<code>Compiler</code>对象（继承<code>Tapable</code>，实现插件的注册），调用目录下的<code>lib/WebpackOptionsApply.js</code>模块</li>
<li>在<code>lib/WebpackOptionsApply.js</code>中根据传入的<code>options</code>和<code>compiler</code>逐个编译并应用不同插件，并且返回文件</li>
</ul>
<h5 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h5><p><a href="https://zhuanlan.zhihu.com/p/24717349" target="_blank" rel="external">[webpack]源码解读：命令行输入webpack的时候都发生了什么？</a></p>
<p><a href="http://www.jianshu.com/p/01a606c97d76" target="_blank" rel="external">webpack源码分析（一）— Tapable插件架构</a></p>
<p><a href="https://juejin.im/entry/576b7aeda633bd0064065c74" target="_blank" rel="external">webpack 源码解析</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/09/14/2017-09-14-write-your-own-react-2/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">rwson</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>