<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Vue源码阅读-入口 · 小宋</title><meta name="description" content="Vue源码阅读-入口 - rwson"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="小宋"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/rwson" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Vue源码阅读-入口</h1><div class="post-info">May 6, 2017</div><div class="post-content"><p>Vue.js框架是目前比较火的MVVM框架之一,简单易上手的学习曲线,友好的官方文档,配套的构建工具,让Vue.js在2016年大放异彩,大有赶超React之势。在2016年,Vue2正式发布,在体积优化、性能提升（vertical-dom，server-side-rending等）、API等各方面都更上一层楼。本人阅读的版本为Vue 2.3。</p>
<h5 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h5><p>我们在使用Vue的时候,都会写下面类似的代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Vue(&#123;</div><div class="line">  <span class="attr">el</span>: <span class="string">"#app"</span>,</div><div class="line">  <span class="comment">// ...</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>new Vue就是创建一个Vue的实例,下面就一起来了解下在这个过程之后都执行了哪些步骤:</p>
<p>在/src/core/index.js这个文件中,export了Vue这个方法给外部,再看export的Vue方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//	Vue构造函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</div><div class="line">    !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)) &#123;</div><div class="line">    warn(<span class="string">'Vue is a constructor and should be called with the `new` keyword'</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">this</span>._init(options)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//	初始化的入口，各种初始化工作</span></div><div class="line">initMixin(Vue)</div><div class="line"></div><div class="line"><span class="comment">//	数据绑定的核心方法，常用的$watch方法</span></div><div class="line">stateMixin(Vue)</div><div class="line"></div><div class="line"><span class="comment">//	事件的核心方法，$on，$off，$emit等方法</span></div><div class="line">eventsMixin(Vue)</div><div class="line"></div><div class="line"><span class="comment">//	生命周期的核心方法</span></div><div class="line">lifecycleMixin(Vue)</div><div class="line"></div><div class="line"><span class="comment">//	渲染的核心方法，用来生成render函数以及VNode</span></div><div class="line">renderMixin(Vue)</div></pre></td></tr></table></figure>
<p>本文先从_init入手,看看其内部实现:</p>
<h5 id="initMixin"><a href="#initMixin" class="headerlink" title="initMixin"></a>initMixin</h5><p>在上面的构造函数中,调用了_init方法,这个方法是在initMixin中实现的:    </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">Vue.prototype._init = <span class="function"><span class="keyword">function</span> (<span class="params">options?: Object</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> vm: Component = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">	<span class="comment">//	生成唯一的uid</span></div><div class="line">    vm._uid = uid++</div><div class="line"></div><div class="line">    <span class="keyword">let</span> startTag, endTag</div><div class="line">    </div><div class="line">    <span class="comment">//	Vue2.2+之后新增的一个特性,关于性能的一个东西(window.performance)</span></div><div class="line">    <span class="comment">//	https://developer.mozilla.org/zh-CN/docs/Web/API/Window/performance</span></div><div class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123;</div><div class="line">      startTag = <span class="string">`vue-perf-init:<span class="subst">$&#123;vm._uid&#125;</span>`</span></div><div class="line">      endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;vm._uid&#125;</span>`</span></div><div class="line">      mark(startTag)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  	<span class="comment">//	_isVue标记,避免当前this被观察</span></div><div class="line">    vm._isVue = <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (options &amp;&amp; options._isComponent) &#123;</div><div class="line">      <span class="comment">//   组件内部实例优化,内部组件的配置项不需要特殊处理(实现在下面)</span></div><div class="line">      initInternalComponent(vm, options)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">//	合并传入的参数到vm.constructor下面</span></div><div class="line">      vm.$options = mergeOptions(</div><div class="line">        </div><div class="line">        <span class="comment">//	解析构造函数配置项[new Vue中传入的内容]</span></div><div class="line">        resolveConstructorOptions(vm.constructor),</div><div class="line">        options || &#123;&#125;,</div><div class="line">        vm</div><div class="line">      )</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">      initProxy(vm)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">//  _renderProxy属性会在下面调用的initRender中被使用</span></div><div class="line">      vm._renderProxy = vm</div><div class="line">    &#125;</div><div class="line">    vm._self = vm</div><div class="line">    </div><div class="line">	<span class="comment">//	初始化声明周期</span></div><div class="line">    initLifecycle(vm)</div><div class="line">    </div><div class="line">    <span class="comment">//	初始化事件</span></div><div class="line">    initEvents(vm)</div><div class="line">    </div><div class="line">	<span class="comment">//	初始化渲染</span></div><div class="line">    initRender(vm)</div><div class="line">    </div><div class="line">   	<span class="comment">//	执行生命周期中的beforeCreate</span></div><div class="line">    callHook(vm, <span class="string">'beforeCreate'</span>)</div><div class="line">    initInjections(vm) <span class="comment">// resolve injections before data/props</span></div><div class="line">    initState(vm)</div><div class="line">    initProvide(vm) <span class="comment">// resolve provide after data/props</span></div><div class="line">    </div><div class="line">    <span class="comment">//	执行生命周期中的created</span></div><div class="line">    callHook(vm, <span class="string">'created'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123;</div><div class="line">      vm._name = formatComponentName(vm, <span class="literal">false</span>)</div><div class="line">      mark(endTag)</div><div class="line">      measure(<span class="string">`<span class="subst">$&#123;vm._name&#125;</span> init`</span>, startTag, endTag)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//	启动</span></div><div class="line">    <span class="keyword">if</span> (vm.$options.el) &#123;</div><div class="line">      vm.$mount(vm.$options.el)</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h5 id="initInternalComponent"><a href="#initInternalComponent" class="headerlink" title="initInternalComponent"></a>initInternalComponent</h5><p>initInternalComponent被用来合并函数内部组件实例配置项,这边直接赋值的方式会比枚举遍历快,所以直接采用赋值的方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initInternalComponent</span> (<span class="params">vm: Component, options: InternalComponentOptions</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> opts = vm.$options = <span class="built_in">Object</span>.create(vm.constructor.options)</div><div class="line">  opts.parent = options.parent</div><div class="line">  opts.propsData = options.propsData</div><div class="line">  opts._parentVnode = options._parentVnode</div><div class="line">  opts._parentListeners = options._parentListeners</div><div class="line">  opts._renderChildren = options._renderChildren</div><div class="line">  opts._componentTag = options._componentTag</div><div class="line">  opts._parentElm = options._parentElm</div><div class="line">  opts._refElm = options._refElm</div><div class="line">  <span class="keyword">if</span> (options.render) &#123;</div><div class="line">    opts.render = options.render</div><div class="line">    opts.staticRenderFns = options.staticRenderFns</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="resolveConstructorOptions"><a href="#resolveConstructorOptions" class="headerlink" title="resolveConstructorOptions"></a>resolveConstructorOptions</h5><p>该方法用来解析构造函数配置项</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveConstructorOptions</span> (<span class="params">vm: Component</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> Ctor = vm.constructor</div><div class="line">    <span class="keyword">let</span> options = Ctor.options</div><div class="line">    <span class="keyword">if</span> (Ctor.super) &#123;</div><div class="line">      <span class="keyword">const</span> superOptions = Ctor.super.options</div><div class="line">      <span class="keyword">const</span> cachedSuperOptions = Ctor.superOptions</div><div class="line">      <span class="keyword">if</span> (superOptions !== cachedSuperOptions) &#123;</div><div class="line">        <span class="comment">// 根组件配置项改变</span></div><div class="line">        Ctor.superOptions = superOptions</div><div class="line">        <span class="comment">// /core/util/options.js</span></div><div class="line">        options = Ctor.options = mergeOptions(superOptions, Ctor.extendOptions)</div><div class="line">         </div><div class="line">        <span class="comment">// 存在有组件名</span></div><div class="line">        <span class="keyword">if</span> (options.name) &#123;</div><div class="line">          options.components[options.name] = Ctor</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> options</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于Vue的启动就先分享到这,下一篇继续分享关于生命周期相关的东西。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/05/09/2017-05-09-read-vue-source-code-2/" class="prev">PREV</a><a href="/2017/03/29/2017-03-29-node-read-regedit-uninstall-software/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">rwson</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>