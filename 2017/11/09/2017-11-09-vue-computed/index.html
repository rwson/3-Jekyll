<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Vue中computed计算属性和watch观察者原理 · 小宋</title><meta name="description" content="Vue中computed计算属性和watch观察者原理 - rwson"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="小宋"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/rwson" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Vue中computed计算属性和watch观察者原理</h1><div class="post-info">Nov 9, 2017</div><div class="post-content"><p>在用<code>Vue</code>做开发中, 我们多多少少都会用到里面两个比较重要的东西: <code>computed</code>和<code>watch</code>, 接下来我们一起分析并简单实现下这两个属性。</p>
<h4 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h4><p><code>computed</code>名为计算属性, 目的就是让我们在模板里面只关注简单的绑定, 不做复杂操作, 拿官网的代码做例子,下面就是一个相对复杂的操作:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"example"</span>&gt;</span></div><div class="line">  &#123;&#123; message.split('').reverse().join('') &#125;&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>先来看下用法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Vue(&#123;</div><div class="line">    data() &#123;</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        firstName: <span class="string">"rw"</span>,</div><div class="line">        lastName: <span class="string">"son"</span>,</div><div class="line">        age: <span class="number">25</span></div><div class="line">      &#125;;</div><div class="line">    &#125;,</div><div class="line">    computed: &#123;</div><div class="line">      <span class="comment">//  指定计算属性的getter</span></div><div class="line">      info() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">`info content: my name is <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>, I'm <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span> years old`</span>;</div><div class="line">      &#125;,</div><div class="line">      <span class="comment">//  同时提供getter和setter, setter中可以操作其他数据</span></div><div class="line">      fullName: &#123;</div><div class="line">        get() &#123;</div><div class="line">          <span class="keyword">return</span> <span class="string">`my fullName is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>;</div><div class="line">        &#125;,</div><div class="line">        set(value) &#123;</div><div class="line">          value = value.split(<span class="string">" "</span>);</div><div class="line">          <span class="keyword">this</span>.firstName = value[<span class="number">0</span>];</div><div class="line">          <span class="keyword">this</span>.lastName = value[value.length - <span class="number">1</span>];</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">	  text: <span class="string">"just a test case"</span></div><div class="line">    &#125;,</div><div class="line">    created() &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.info);</div><div class="line">      <span class="comment">//  info content: my name is rwson, I'm 25 years old</span></div><div class="line"></div><div class="line">      <span class="keyword">this</span>.fullName = <span class="string">"son rw"</span>;</div><div class="line"></div><div class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.info);</div><div class="line">      <span class="comment">//  info content: my name is sonrw, I'm 25 years old</span></div><div class="line"></div><div class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.fullName);</div><div class="line">      <span class="comment">//  my fullName is: sonrw</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>computed</code>的用法就是上面例子中的两种, 下面我们一起来模拟实现下:</p>
<p>首先我们模拟封装一个<code>Vm</code>函数作为构造器, 然后去调用它,</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vm(&#123;</div><div class="line">	data() &#123;</div><div class="line">		<span class="keyword">return</span> &#123;</div><div class="line">			firstName: <span class="string">"rw"</span>,</div><div class="line">			lastName: <span class="string">"son"</span>,</div><div class="line">			age: <span class="number">25</span></div><div class="line">		&#125;;</div><div class="line">	&#125;,</div><div class="line">	computed: &#123;</div><div class="line">		info() &#123;</div><div class="line">			<span class="keyword">return</span> <span class="string">`info content: my name is <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>, I'm <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span> years old`</span>;</div><div class="line">		&#125;,</div><div class="line">		fullName: &#123;</div><div class="line">			get() &#123;</div><div class="line">				<span class="keyword">return</span> <span class="string">`my fullName is: <span class="subst">$&#123;<span class="keyword">this</span>.firstName&#125;</span><span class="subst">$&#123;<span class="keyword">this</span>.lastName&#125;</span>`</span>;</div><div class="line">			&#125;,</div><div class="line">			set(value) &#123;</div><div class="line">				value = value.split(<span class="string">" "</span>);</div><div class="line">				<span class="keyword">this</span>.firstName = value[<span class="number">0</span>];</div><div class="line">				<span class="keyword">this</span>.lastName = value[value.length - <span class="number">1</span>];</div><div class="line">			&#125;</div><div class="line">		&#125;,</div><div class="line">		text: <span class="string">"just a test case"</span></div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(vm.text);</div><div class="line"><span class="comment">//	just a test case</span></div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(vm.info);</div><div class="line"><span class="comment">//	info content: my name is rwson, I'm 25 years old</span></div><div class="line"></div><div class="line">vm.fullName = <span class="string">"song rw"</span>;</div><div class="line"><span class="built_in">console</span>.log(vm.info);</div><div class="line"><span class="comment">//	info content: my name is songrw, I'm 25 years old</span></div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(vm.firstName);</div><div class="line"><span class="comment">//	song</span></div></pre></td></tr></table></figure>
<p>上面是运行结果和调用, 下面我们一起实现下<code>Vm</code>这个函数:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//	vm构造函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vm</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">	<span class="keyword">const</span> data = obj.data();</div><div class="line"></div><div class="line">	<span class="comment">//	处理data执行的返回结果</span></div><div class="line">	handleData(<span class="keyword">this</span>, data);</div><div class="line">	</div><div class="line">	<span class="comment">//	处理compoted对象</span></div><div class="line">	handleComputed(<span class="keyword">this</span>, obj.computed);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//	hasOwnProperty简写</span></div><div class="line"><span class="keyword">const</span> hasOwnProp = <span class="function">(<span class="params">obj, prop</span>) =&gt;</span> obj.hasOwnProperty(prop);</div><div class="line"></div><div class="line"><span class="comment">//	获取prototype类名</span></div><div class="line"><span class="keyword">const</span> typeOf = <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</div><div class="line">	<span class="keyword">return</span> &#123;&#125;.toString.call(obj).slice(<span class="number">8</span>, <span class="number">-1</span>).toLowerCase();</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//	枚举对象</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loopObj</span>(<span class="params">obj, callback</span>) </span>&#123;</div><div class="line">	 <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</div><div class="line">		callback(key, obj[key], obj);</div><div class="line">	&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//	给data用Object.defineProperty绑定</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleData</span>(<span class="params">context, data</span>) </span>&#123;</div><div class="line">	loopObj(data, (key, val, data) =&gt; &#123;</div><div class="line">		defineProp(context, key, val);</div><div class="line">	&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//	处理computed属性</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleComputed</span>(<span class="params">context, obj</span>) </span>&#123;</div><div class="line">	<span class="keyword">let</span> type;</div><div class="line">	loopObj(obj, (key, val, obj) =&gt; &#123;</div><div class="line">		defineProp(context, key, val);</div><div class="line">	&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineProp</span>(<span class="params">obj, key, val</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> _val = val, type;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">        enumerable: <span class="literal">true</span>,</div><div class="line">        configable: <span class="literal">true</span>,</div><div class="line">        get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            type = typeOf(_val);</div><div class="line">            <span class="keyword">switch</span> (type) &#123;</div><div class="line">            	<span class="comment">/**</span></div><div class="line"><span class="comment">            	 * 属性值对应一个函数, 也就是computed里面只声明了getter</span></div><div class="line"><span class="comment">            	 * eg.</span></div><div class="line"><span class="comment">            	 * ...</span></div><div class="line"><span class="comment">            	 * computed: &#123;</span></div><div class="line"><span class="comment">            	 * 		info() &#123;</span></div><div class="line"><span class="comment">            	 * 			return `info content: my name is $&#123;this.firstName&#125;$&#123;this.lastName&#125;, I'm $&#123;this.age&#125; years old`;</span></div><div class="line"><span class="comment">            	 * 		&#125;</span></div><div class="line"><span class="comment">            	 * 		...</span></div><div class="line"><span class="comment">            	 * &#125;</span></div><div class="line"><span class="comment">            	 * ...</span></div><div class="line"><span class="comment">            	 */</span></div><div class="line">            	<span class="keyword">case</span> <span class="string">"function"</span>:</div><div class="line">            		<span class="keyword">return</span> _val.call(obj);</div><div class="line">            	<span class="keyword">break</span>;</div><div class="line"></div><div class="line">            	<span class="comment">/**</span></div><div class="line"><span class="comment">            	 * 属性值对应一个对象, 也就是computed里面同时声明了getter/setter</span></div><div class="line"><span class="comment">            	 * eg.</span></div><div class="line"><span class="comment">            	 * ...</span></div><div class="line"><span class="comment">            	 * computed: &#123;</span></div><div class="line"><span class="comment">            	 * 		fullName: &#123;</span></div><div class="line"><span class="comment">            	 * 			get() &#123;</span></div><div class="line"><span class="comment">            	 * 				return `my fullName is: $&#123;this.firstName&#125;$&#123;this.lastName&#125;`;</span></div><div class="line"><span class="comment">            	 * 			&#125;,</span></div><div class="line"><span class="comment">            	 * 			set() &#123;</span></div><div class="line"><span class="comment">            	 * 				value = value.split(" ");</span></div><div class="line"><span class="comment">            	 * 				this.firstName = value[0];</span></div><div class="line"><span class="comment">            	 * 				this.lastName = value[value.length - 1];</span></div><div class="line"><span class="comment">            	 * 			&#125;</span></div><div class="line"><span class="comment">            	 * 		&#125;</span></div><div class="line"><span class="comment">            	 * &#125;</span></div><div class="line"><span class="comment">            	 * ...</span></div><div class="line"><span class="comment">            	 */</span></div><div class="line">            	<span class="keyword">case</span> <span class="string">"object"</span>:</div><div class="line">            		<span class="keyword">return</span> _val.get.call(obj);</div><div class="line">            	<span class="keyword">break</span>;</div><div class="line"></div><div class="line">            	<span class="comment">//	其他类型默认</span></div><div class="line">            	<span class="keyword">default</span>:</div><div class="line">            		<span class="keyword">return</span> _val;</div><div class="line">            	<span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        set: <span class="function"><span class="keyword">function</span>(<span class="params">newV</span>) </span>&#123;</div><div class="line">        	type = typeOf(_val);</div><div class="line">        	<span class="keyword">switch</span> (type) &#123;</div><div class="line">        		<span class="comment">//	属性值对应一个对象, 也就是computed里面同时声明了getter/setter</span></div><div class="line">        		<span class="keyword">case</span> <span class="string">"object"</span>:</div><div class="line">        			_val.set.call(obj, newV);</div><div class="line">        		<span class="keyword">break</span>;</div><div class="line"></div><div class="line">        		<span class="comment">//	其他类型的默认</span></div><div class="line">        		<span class="keyword">default</span>:</div><div class="line">        			<span class="keyword">if</span> (newV !== _val) &#123;</div><div class="line">        				_val = newV;</div><div class="line">        			&#125;</div><div class="line">        		<span class="keyword">break</span>;</div><div class="line">        	&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面就是我们一个实现了, 其中<code>defineProp</code>这个函数中, 我们做了下面几步:</p>
<ol>
<li>缓存当前属性值</li>
<li>调用Object.defineProperty方法在obj上定义属性key</li>
<li>在<code>descriptor</code>中的<code>getter</code>/<code>setter</code>里面判断属性值类型(如果是函数或者对象, 那该属性就是在<code>computed</code>[先不谈<code>watch</code>]里面声明的, <code>getter</code>里面返回该函数的执行结果、<code>setter</code>里面执行<code>computed</code>中指定的<code>set</code>函数[如果有的话], 否则作为普通的<code>data</code>处理)</li>
</ol>
<h4 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h4><p><code>watch</code>名为观察者, 通过监听组件内某个属性来执行某些操作, 最常用的就是组件中某个属性值发生变化之后, 向后端发送一个异步请求, 比如一些商品网站上有顶部tab栏, 每个tab都是一个类目, 这时候我们可以给这些tab绑定<code>click</code>事件, 然后在事件处理中处理顶部tab栏绑定的属性值, watch中去监听它的变化来发送异步请求等等, 比如下面的例子:</p>
<p>先来看模板部分:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('1')"</span>&gt;</span>男装<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('2')"</span>&gt;</span>女装<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('3')"</span>&gt;</span>童装<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">li</span> @<span class="attr">click</span>=<span class="string">"setFilter('4')"</span>&gt;</span>美食<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>然后我们看看js部分实现:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span>() &#123;</div><div class="line">	data() &#123;</div><div class="line">		<span class="keyword">return</span> &#123;</div><div class="line">			page: <span class="number">1</span>,</div><div class="line">			filter: <span class="string">"1"</span>,</div><div class="line">			goodsList: []</div><div class="line">		&#125;;</div><div class="line">	&#125;,</div><div class="line">	watch: &#123;</div><div class="line">		<span class="keyword">async</span> filter() &#123;</div><div class="line">			<span class="keyword">const</span> &#123; filter, page &#125; = <span class="keyword">this</span>,</div><div class="line">				res = <span class="keyword">await</span> <span class="keyword">this</span>.queryGoods(filter, page);</div><div class="line">			<span class="keyword">if</span> (res.success) &#123;</div><div class="line">				<span class="keyword">this</span>.goodsList = res.goods;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;,</div><div class="line">	methods: &#123;</div><div class="line">		setFilter(filter) &#123;</div><div class="line">			<span class="keyword">this</span>.filter = filter;</div><div class="line">			<span class="keyword">this</span>.page = <span class="number">1</span>;</div><div class="line">			<span class="keyword">this</span>.goodsList = [];</div><div class="line">		&#125;,</div><div class="line">		<span class="keyword">async</span> queryGoods(filter, page) &#123;</div><div class="line">			<span class="comment">//	...</span></div><div class="line">		&#125;</div><div class="line">	&#125;,</div><div class="line">	<span class="comment">//	...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然这个例子可能有点极端, 因为<code>queryGoods</code>完全可以放在<code>setFilter</code>里面去调用, 但是为了演示效果, 只能这么做了😂</p>
<p>下面一起看看看看<code>watch</code>部分的实现, 有了刚才的分析, 我们知道<code>watch</code>中声明的肯定是在<code>setter</code>部分进行调用的, 所以我们需要在处理<code>data</code>的时候就把<code>watch</code>对应的加上:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//	首先我们需要在构造函数里面, 改下handleData这个函数的调用, 给它把obj.watch也传进行</span></div><div class="line"><span class="comment">// handleData(this, data);</span></div><div class="line">handleData(<span class="keyword">this</span>, data, obj.watch);</div><div class="line"></div><div class="line"><span class="comment">//	接下来我们改写handleData这个函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleData</span>(<span class="params">context, data, watch</span>) </span>&#123;</div><div class="line">	<span class="keyword">let</span> inWatch, watchVal;</div><div class="line">	loopObj(data, (key, val, data) =&gt; &#123;</div><div class="line">		<span class="comment">//	判断在watch中是否也声明了该属性值</span></div><div class="line">		inWatch = hasOwnProp(watch, key);</div><div class="line">		<span class="comment">//	如果有取出来, 作为defineProp的第五个参数给传进去</span></div><div class="line">		watchVal = inWatch ? watch[key] : <span class="literal">null</span>;</div><div class="line">		defineProp(context, key, val, inWatch, watchVal);</div><div class="line">	&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//	下面就是我们说到的在setter部分调用声明的watch观察者</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineProp</span>(<span class="params">obj, key, val, inWatch = false, watchVal = (</span>) =&gt; </span>&#123;&#125;) &#123;</div><div class="line">    <span class="keyword">let</span> _val = val, type;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</div><div class="line">        enumerable: <span class="literal">true</span>,</div><div class="line">        configable: <span class="literal">true</span>,</div><div class="line">        get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            type = typeOf(_val);</div><div class="line">            <span class="keyword">switch</span> (type) &#123;</div><div class="line">            	<span class="comment">/**</span></div><div class="line"><span class="comment">            	 * 属性值对应一个函数, 也就是computed里面只声明了getter</span></div><div class="line"><span class="comment">            	 * eg.</span></div><div class="line"><span class="comment">            	 * ...</span></div><div class="line"><span class="comment">            	 * computed: &#123;</span></div><div class="line"><span class="comment">            	 * 		info() &#123;</span></div><div class="line"><span class="comment">            	 * 			return `info content: my name is $&#123;this.firstName&#125;$&#123;this.lastName&#125;, I'm $&#123;this.age&#125; years old`;</span></div><div class="line"><span class="comment">            	 * 		&#125;</span></div><div class="line"><span class="comment">            	 * 		...</span></div><div class="line"><span class="comment">            	 * &#125;</span></div><div class="line"><span class="comment">            	 * ...</span></div><div class="line"><span class="comment">            	 */</span></div><div class="line">            	<span class="keyword">case</span> <span class="string">"function"</span>:</div><div class="line">            		<span class="keyword">return</span> _val.call(obj);</div><div class="line">            	<span class="keyword">break</span>;</div><div class="line"></div><div class="line">            	<span class="comment">/**</span></div><div class="line"><span class="comment">            	 * 属性值对应一个对象, 也就是computed里面同时声明了getter/setter</span></div><div class="line"><span class="comment">            	 * eg.</span></div><div class="line"><span class="comment">            	 * ...</span></div><div class="line"><span class="comment">            	 * computed: &#123;</span></div><div class="line"><span class="comment">            	 * 		fullName: &#123;</span></div><div class="line"><span class="comment">            	 * 			get() &#123;</span></div><div class="line"><span class="comment">            	 * 				return `my fullName is: $&#123;this.firstName&#125;$&#123;this.lastName&#125;`;</span></div><div class="line"><span class="comment">            	 * 			&#125;,</span></div><div class="line"><span class="comment">            	 * 			set() &#123;</span></div><div class="line"><span class="comment">            	 * 				value = value.split(" ");</span></div><div class="line"><span class="comment">            	 * 				this.firstName = value[0];</span></div><div class="line"><span class="comment">            	 * 				this.lastName = value[value.length - 1];</span></div><div class="line"><span class="comment">            	 * 			&#125;</span></div><div class="line"><span class="comment">            	 * 		&#125;</span></div><div class="line"><span class="comment">            	 * &#125;</span></div><div class="line"><span class="comment">            	 * ...</span></div><div class="line"><span class="comment">            	 */</span></div><div class="line">            	<span class="keyword">case</span> <span class="string">"object"</span>:</div><div class="line">            		<span class="keyword">return</span> _val.get.call(obj);</div><div class="line">            	<span class="keyword">break</span>;</div><div class="line"></div><div class="line">            	<span class="comment">//	其他类型默认</span></div><div class="line">            	<span class="keyword">default</span>:</div><div class="line">            		<span class="keyword">return</span> _val;</div><div class="line">            	<span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        set: <span class="function"><span class="keyword">function</span>(<span class="params">newV</span>) </span>&#123;</div><div class="line">        	type = typeOf(_val);</div><div class="line">        	<span class="keyword">switch</span> (type) &#123;</div><div class="line">        		<span class="comment">//	属性值对应一个对象, 也就是computed里面同时声明了getter/setter</span></div><div class="line">        		<span class="keyword">case</span> <span class="string">"object"</span>:</div><div class="line">        			_val.set.call(obj, newV);</div><div class="line">        		<span class="keyword">break</span>;</div><div class="line"></div><div class="line">        		<span class="comment">//	其他类型的默认</span></div><div class="line">        		<span class="keyword">default</span>:</div><div class="line">        			<span class="keyword">if</span> (newV !== _val) &#123;</div><div class="line">        				_val = newV;</div><div class="line">        			&#125;</div><div class="line">        		<span class="keyword">break</span>;</div><div class="line">        	&#125;</div><div class="line"></div><div class="line">			<span class="comment">//	如果watch观察者存在, 并且对应一个回调函数, 在值发生改变的时候调用该回调, 并修改this指向到当前vm实例</span></div><div class="line">            <span class="keyword">if</span> (inWatch &amp;&amp; typeOf(watchVal) === <span class="string">"function"</span>) &#123;</div><div class="line">            	watchVal.call(obj);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再来看下用法:</p>
<p>const vm = new Vm({<br>    data() {<br>        return {<br>            firstName: “rw”,<br>            lastName: “son”,<br>            age: 25<br>        };<br>    },<br>    computed: {<br>        info() {<br>            return <code>info content: my name is ${this.firstName}${this.lastName}, I&#39;m ${this.age} years old</code>;<br>        },<br>        fullName: {<br>            get() {<br>                return <code>my fullName is: ${this.firstName}${this.lastName}</code>;<br>            },<br>            set(value) {<br>                value = value.split(“ “);<br>                this.firstName = value[0];<br>                this.lastName = value[value.length - 1];<br>            }<br>        },<br>        text: “just a test case”<br>    },<br>    watch: {<br>        firstName() {<br>            console.log(<code>%c now firstName&#39;s value is: ${this.firstName}</code>, “color: red”);<br>            //    走到vm.fullName = “song rw”;就会输出<br>        },<br>        lastName() {<br>            console.log(<code>%c now lastName&#39;s value is: ${this.lastName}</code>, “color: green”);<br>            //    走到vm.fullName = “song rw”;就会输出<br>        },<br>        age() {<br>            console.log(<code>%c now age&#39;s value is: ${this.age}</code>, “color: yellow”);<br>            //    走到vm.fullName = “song rw”;就会输出<br>        }<br>    }<br>});</p>
<p>console.log(vm.text);<br>console.log(vm.info);<br>vm.fullName = “song rw”;<br>console.log(vm.info);<br>console.log(vm.firstName);</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/10/24/2017-10-24-write-a-sublime-plugin-by-python-nodejs/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">rwson</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>