<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> redux-logic源码阅读 · 小宋</title><meta name="description" content="redux-logic源码阅读 - rwson"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="小宋"><link rel="alternate" href="/atom.xml" title="小宋" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">redux-logic源码阅读</h1><div class="post-info">Jun 6, 2018</div><div class="post-content"><p>在用<a href="https://reactjs.org/" target="_blank" rel="noopener">React</a>和<a href="https://redux.js.org/" target="_blank" rel="noopener">Redux</a>做开发时, 都会用到异步的一些东西, 之前更多的用的是<code>redux-thunk</code>或者<code>redux-saga</code>之类的, 但是都有用的不顺的地方, 有一次突然发现<a href="https://github.com/jeffbski/redux-logic" target="_blank" rel="noopener">redux-logic</a>是一个很不错的解决方案, 用起来也感觉很顺手, 与市面上其他<code>redux</code>中间件不同的分析都在<a href="https://codewinds.com/assets/article/redux-logic-nodevember.pdf" target="_blank" rel="noopener">这里</a>, 感兴趣的可以自己查看。</p>
<p>首先我们来看下<code>redux-logic</code>的基本用法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//	logic/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createLogic &#125; <span class="keyword">from</span> <span class="string">'redux-logic'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> someLogic = createLogic(&#123;</span><br><span class="line">	<span class="comment">//	当前logic监听的actionType</span></span><br><span class="line">	type: <span class="string">'SOME_ACTION_TYPE'</span>,</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	取消当前logic执行的actionType</span></span><br><span class="line">	cancelType: <span class="string">'CANCEL_TYPE'</span>,</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	是否获取最后一个返回</span></span><br><span class="line">	latest: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	当前actionType的业务逻辑</span></span><br><span class="line">	<span class="keyword">async</span> process(&#123; getState, action, cancelled &#125;, dispatch, done) &#123;</span><br><span class="line">		<span class="keyword">const</span> res = <span class="keyword">await</span> asyncFn();</span><br><span class="line">		dispatch(newAction(&#123;</span><br><span class="line">			...res</span><br><span class="line">		&#125;));</span><br><span class="line">		done();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> someLogic;</span><br><span class="line"></span><br><span class="line"><span class="comment">//	store/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createLogicMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux-logic'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; routerMiddleware &#125; <span class="keyword">from</span> <span class="string">'react-router-redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'../reducers'</span>;</span><br><span class="line"><span class="keyword">import</span> history <span class="keyword">from</span> <span class="string">'../history'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; someLogic &#125; <span class="keyword">from</span> <span class="string">'../logic'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> configureStore = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> reduxRouteMiddleware = routerMiddleware(history),</span><br><span class="line"></span><br><span class="line">		<span class="comment">//	将所有的logic应用到中间件中</span></span><br><span class="line">    	loggicMiddleware = createLogicMiddleware([someLogic]),</span><br><span class="line">    	middlewares = process.env.NODE_ENV === <span class="string">'development'</span> ? [loggicMiddleware, reduxRouteMiddleware, logger] : [loggicMiddleware, reduxRouteMiddleware],</span><br><span class="line">        createStoreWithMiddleware = applyMiddleware(...middlewares)(createStore),</span><br><span class="line">        store = createStoreWithMiddleware(reducer);</span><br><span class="line">    <span class="keyword">return</span> store;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> configureStore();</span><br></pre></td></tr></table></figure>
<p>本文会逐步分析<code>redux-logic</code>的相关实现, 首先把<a href="https://github.com/jeffbski/redux-logic" target="_blank" rel="noopener">redux-logic</a>克隆到本地, 源码都位于<code>redux-logic/src</code>里面, 所以我们从<code>src/index.js</code>开始:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> createLogic, &#123; configureLogic &#125; <span class="keyword">from</span> <span class="string">'./createLogic'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> createLogicMiddleware <span class="keyword">from</span> <span class="string">'./createLogicMiddleware'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  configureLogic,</span><br><span class="line">  createLogic,</span><br><span class="line">  createLogicMiddleware</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  configureLogic,</span><br><span class="line">  createLogic,</span><br><span class="line">  createLogicMiddleware</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>从上面的代码中可以看到, 一共导出3个函数, <code>configureLogic</code>的功能就是对所有的<code>logic</code>进行配置(超时警告时间等), 我们主要看<code>createLogic</code>和<code>createLogicMiddleware</code>:</p>
<ul>
<li>createLogic</li>
</ul>
<p><code>createLogic</code>位于<code>src/createLogic</code>里</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个Logic对象</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125; logicOptions</span></span><br><span class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.name           可选值, 主要用于Logic中的异常提示, 可选值</span></span><br><span class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.type           触发当前Logic的redux action type</span></span><br><span class="line"><span class="comment"> *         @param  &#123;String&#125;     logicOptions.cancelType     取消执行当前Logic的redux action type</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Boolean&#125;    logicOptions.latest         是否只获取最后一次的结果,类似redux-saga中的takeLatest effect</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Number&#125;     logicOptions.debounce       函数去抖配置, 单位为毫秒</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Object&#125;     logicOptions.throttle       函数节流配置, 单位为毫秒</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.validate       在执行process之前的一个钩子, 可以对当前action执行一些操作</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.transform      validate的一个别名, validate和transform只需指定一个即可</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Function&#125;   logicOptions.process        当前redux action type对应的处理逻辑(发起异步请求, 在异步请求返回成功之后触发新的redux action)</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Object&#125;     logicOptions.processOptions process中需要的一些配置</span></span><br><span class="line"><span class="comment"> *         @param  &#123;Number&#125;     logicOptions.warnTimeout    超时警告时间, 默认60秒, 需要在process中手动调用done来终止这个Logic, 如果是一个持续性的Logic, warnTimeout需要设置成0</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;              创建出来的Logic</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogic</span>(<span class="params">logicOptions = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//  无效配置项验证, 把无效的配置项键名放数组返回</span></span><br><span class="line">    <span class="keyword">const</span> invalidOptions = getInvalidOptions(logicOptions, allowedOptions);</span><br><span class="line">    <span class="keyword">if</span> (invalidOptions.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unknown or misspelled option(s): <span class="subst">$&#123;invalidOptions&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  name, type, cancelType, validate, transform都从传入的logicOptions里面获取</span></span><br><span class="line">    <span class="comment">//  如果其他配置项没有在logicOptions中声明, 就从默认配置中获取或者给一个默认值</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        name,</span><br><span class="line">        type,</span><br><span class="line">        cancelType,</span><br><span class="line">        warnTimeout = defaultOptions.warnTimeout,</span><br><span class="line">        latest = defaultOptions.latest,</span><br><span class="line">        debounce = defaultOptions.debounce,</span><br><span class="line">        throttle = defaultOptions.throttle,</span><br><span class="line">        validate,</span><br><span class="line">        transform,</span><br><span class="line">        process = emptyProcess,</span><br><span class="line">        processOptions = &#123;&#125;</span><br><span class="line">    &#125; = logicOptions;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  type必传</span></span><br><span class="line">    <span class="keyword">if</span> (!type) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'type is required, use \'*\' to match all actions'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  validate和tranform只能同时指定一个</span></span><br><span class="line">    <span class="keyword">if</span> (validate &amp;&amp; transform) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'logic cannot define both the validate and transform hooks they are aliases'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  warnTimeout需要放在processOptions同级</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> processOptions.warnTimeout !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'warnTimeout is a top level createLogic option, not a processOptions option'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  获取processOptions中的无效配置项</span></span><br><span class="line">    <span class="keyword">const</span> invalidProcessOptions = getInvalidOptions(processOptions, allowedProcessOptions);</span><br><span class="line">    <span class="keyword">if</span> (invalidProcessOptions.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unknown or misspelled processOption(s): <span class="subst">$&#123;invalidProcessOptions&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  如果validate和transform都没传入,就用默认的, 否则就用传入的validate</span></span><br><span class="line">    <span class="keyword">const</span> validateDefaulted = (!validate &amp;&amp; !transform) ?</span><br><span class="line">        identityValidation :</span><br><span class="line">        validate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  如果在processOptions里面指定了dispatchMultiple, warnTimeout应该是0</span></span><br><span class="line">    <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> processOptions.dispatchMultiple !== <span class="string">'undefined'</span> &amp;&amp;</span><br><span class="line">        warnTimeout !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">`warning: in logic for type(s): <span class="subst">$&#123;type&#125;</span> - dispatchMultiple is always true in next version. For non-ending logic, set warnTimeout to 0`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        根据process.length可以获取传入的process对应的处理函数中的形参个数</span></span><br><span class="line"><span class="comment">        从而确定processOption中的一些默认值</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        const fn = function(arg1, agr2) &#123;&#125;;</span></span><br><span class="line"><span class="comment">        console.log(fn.length);  -&gt; 2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        const fn = function(arg1, agr2, arg3) &#123;&#125;;</span></span><br><span class="line"><span class="comment">        console.log(fn.length); -&gt; 3</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="keyword">switch</span> (process.length) &#123;</span><br><span class="line">        <span class="comment">//  如果没有或只有一个形参没有传入且dispatchReturn没有在processOptions传入, 就把它设置成true</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            setIfUndefined(processOptions, <span class="string">'dispatchReturn'</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  两个形参(single-dispatch模式[已废弃])</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">                !processOptions.dispatchMultiple &amp;&amp;</span><br><span class="line">                warnTimeout !== <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(<span class="string">`warning: in logic for type(s): <span class="subst">$&#123;type&#125;</span> - single-dispatch mode is deprecated, call done when finished dispatching. For non-ending logic, set warnTimeout: 0`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">            3个形参及更多, 认为是multi-dispatch模式</span></span><br><span class="line"><span class="comment">            processOptions.dispatchMultiple = processOptions === undefined ? true : processOptions.dispatchMultiple</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            setIfUndefined(processOptions, <span class="string">'dispatchMultiple'</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  返回处理好的对象</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        name: typeToStrFns(name),</span><br><span class="line">        type: typeToStrFns(type),</span><br><span class="line">        cancelType: typeToStrFns(cancelType),</span><br><span class="line">        latest,</span><br><span class="line">        debounce,</span><br><span class="line">        throttle,</span><br><span class="line">        validate: validateDefaulted,</span><br><span class="line">        transform,</span><br><span class="line">        process,</span><br><span class="line">        processOptions,</span><br><span class="line">        warnTimeout</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的分析中我们可以得出: 在<code>createLogic</code>中做的主要是一些参数的验证和默认值的处理, 下面我们一起看看他里面的调用的一些的实现:</p>
<p>先来看下<code>getInvalidOptions</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getInvalidOptions</span>(<span class="params">options, validOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.keys(options)</span><br><span class="line">    .filter(<span class="function"><span class="params">k</span> =&gt;</span> validOptions.indexOf(k) === <span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**	比如在createLogic里的第一行就调用了该方法</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">export default function createLogic(logicOptions = &#123;&#125;) &#123;</span></span><br><span class="line"><span class="comment">  const invalidOptions = getInvalidOptions(logicOptions, allowedOptions);</span></span><br><span class="line"><span class="comment">  //	...</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">const allowedOptions = [</span></span><br><span class="line"><span class="comment">  'name',</span></span><br><span class="line"><span class="comment">  'type',</span></span><br><span class="line"><span class="comment">  'cancelType',</span></span><br><span class="line"><span class="comment">  'latest',</span></span><br><span class="line"><span class="comment">  'debounce',</span></span><br><span class="line"><span class="comment">  'throttle',</span></span><br><span class="line"><span class="comment">  'validate',</span></span><br><span class="line"><span class="comment">  'transform',</span></span><br><span class="line"><span class="comment">  'process',</span></span><br><span class="line"><span class="comment">  'processOptions',</span></span><br><span class="line"><span class="comment">  'warnTimeout'</span></span><br><span class="line"><span class="comment">];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>
<p>从上面的分析中我们可以看出, <code>getInvalidOptions</code>用来获取<code>Object</code>里的不合法的配置项, 并把非法的<code>key</code>作为数组的形式返回。</p>
<p><code>typeToStrFns</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	如果是数组形式就针对数组的每一项都调用typeToStrFns, 返回一个新数组</span></span><br><span class="line"><span class="comment">//	如果是函数形式就返回函数体的字符串形式</span></span><br><span class="line"><span class="comment">//	其它直接返回</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">typeToStrFns</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(type)) &#123; <span class="keyword">return</span> type.map(<span class="function"><span class="params">x</span> =&gt;</span> typeToStrFns(x)); &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) ?</span><br><span class="line">    type.toString() :</span><br><span class="line">    type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>setIfUndefined</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setIfUndefined</span>(<span class="params">obj, propName, propValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj[propName] === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    obj[propName] = propValue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没什么好说的😂</p>
<ul>
<li>createLogicMiddleware<br><code>createLogic</code>分析完了, 下面一起看看<code>createLogicMiddleware</code>, <code>createLogicMiddleware</code>位于<code>src/createLogicMiddleware</code>里:</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	@param arrLogic  Array.&lt;logic&gt;</span></span><br><span class="line"><span class="comment">	@param deps 	 Object</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogicMiddleware</span>(<span class="params">arrLogic = [], deps = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(arrLogic)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'createLogicMiddleware needs to be called with an array of logic items'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	判断是否有重复的logic</span></span><br><span class="line">  <span class="keyword">const</span> duplicateLogic = findDuplicates(arrLogic);</span><br><span class="line">  <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		因为redux-logic集成了rxjs</span></span><br><span class="line"><span class="comment">		所以Subject和BehaviorSubject都是rxjs里的主体</span></span><br><span class="line"><span class="comment">		BehaviorSubject作为Subject的一个变体, 和Subject不同的是它有一个初始值</span></span><br><span class="line"><span class="comment">		https://cn.rx.js.org/manual/overview.html#h15</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">  <span class="keyword">const</span> actionSrc$ = <span class="keyword">new</span> Subject();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	用来监视所有action</span></span><br><span class="line">  <span class="keyword">const</span> monitor$ = <span class="keyword">new</span> Subject();</span><br><span class="line">  <span class="keyword">const</span> lastPending$ = <span class="keyword">new</span> BehaviorSubject(&#123; <span class="attr">op</span>: OP_INIT &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	对monitor$使用累加器函数,返回生成的中间值,可选的初始值</span></span><br><span class="line">  monitor$</span><br><span class="line">    .scan(<span class="function">(<span class="params">acc, x</span>) =&gt;</span> &#123; <span class="comment">// 追加一个pending状态的计数器</span></span><br><span class="line">      <span class="keyword">let</span> pending = acc.pending || <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">switch</span> (x.op) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'top'</span> : 		<span class="comment">// 当前action位于logic栈的顶级</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'begin'</span> : 		<span class="comment">// 开始触发一个action</span></span><br><span class="line">          pending += <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">			在createLogic里的process中调用了done, done的实现稍候分析;</span></span><br><span class="line"><span class="comment">		**/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'end'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'bottom'</span>: 			<span class="comment">// action变成了一个被转换后的新action</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">			在createLogic里的validate中调用了allow, 且触发了一个新的action</span></span><br><span class="line"><span class="comment">			craeteLogic(&#123;</span></span><br><span class="line"><span class="comment">				...</span></span><br><span class="line"><span class="comment">				validate(&#123; getState, action &#125;, allow, reject) &#123;</span></span><br><span class="line"><span class="comment">					allow(action);</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">			&#125;)</span></span><br><span class="line"><span class="comment">		**/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'nextDisp'</span> :</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'filtered'</span> : 		<span class="comment">// 	当前action由于无效被过滤</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'dispatchError'</span> : <span class="comment">// 	派发action的时候异常(好像暂时没用到)</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">			在action拦截器(validate)里面执行reject</span></span><br><span class="line"><span class="comment">			craeteLogic(&#123;</span></span><br><span class="line"><span class="comment">				...</span></span><br><span class="line"><span class="comment">				validate(&#123; getState, action &#125;, allow, reject) &#123;</span></span><br><span class="line"><span class="comment">					reject(action);</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">			&#125;)</span></span><br><span class="line"><span class="comment">		**/</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'cancelled'</span>:</span><br><span class="line">          pending -= <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...x,</span><br><span class="line">        pending</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, &#123; <span class="attr">pending</span>: <span class="number">0</span> &#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	https://cn.rx.js.org/manual/usage.html</span></span><br><span class="line">    .subscribe(lastPending$);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> savedStore;</span><br><span class="line">  <span class="keyword">let</span> savedNext;</span><br><span class="line">  <span class="keyword">let</span> actionEnd$;</span><br><span class="line">  <span class="keyword">let</span> logicSub;</span><br><span class="line">  <span class="keyword">let</span> logicCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	缓存传入的logic数组</span></span><br><span class="line">  <span class="keyword">let</span> savedLogicArr = arrLogic;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	调用完createLogicMiddleware后返回的redux中间件</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mw</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//	多次调用了createLogicMiddleware, 并且传入了不同的store</span></span><br><span class="line">    <span class="keyword">if</span> (savedStore &amp;&amp; savedStore !== store) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'cannot assign logicMiddleware instance to multiple stores, create separate instance for each'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	缓存本次调用传入的store</span></span><br><span class="line">    savedStore = store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> &#123;</span><br><span class="line">      savedNext = next;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//	从applyLogic返回中获取action$, sub, 把logicCount赋值给cnt</span></span><br><span class="line">      <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</span><br><span class="line">            applyLogic(arrLogic, savedStore, savedNext,</span><br><span class="line">                       logicSub, actionSrc$, deps, logicCount,</span><br><span class="line">                       monitor$);</span><br><span class="line">      actionEnd$ = action$;</span><br><span class="line">      logicSub = sub;</span><br><span class="line">      logicCount = cnt;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">        debug(<span class="string">'starting off'</span>, action);</span><br><span class="line">        monitor$.next(&#123; action, <span class="attr">op</span>: <span class="string">'top'</span> &#125;);</span><br><span class="line">        actionSrc$.next(action);</span><br><span class="line">        <span class="keyword">return</span> action;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//	给mw挂载一个指向monitor$的monitor$属性</span></span><br><span class="line">  mw.monitor$ = monitor$;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一个自定义钩子函数, 主要用于测试</span></span><br><span class="line"><span class="comment">     * @param  &#123;Function&#125; fn   可写入相关测试逻辑</span></span><br><span class="line"><span class="comment">     * @return &#123;Objetc&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mw.whenComplete = <span class="function"><span class="keyword">function</span> <span class="title">whenComplete</span>(<span class="params">fn = identity</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastPending$</span><br><span class="line">            <span class="comment">//  只有当x.pending &gt; 0是才继续往下走</span></span><br><span class="line">            .takeWhile(<span class="function"><span class="params">x</span> =&gt;</span> x.pending)</span><br><span class="line">            .map(<span class="function">(<span class="params"> <span class="regexp">/* x */</span> </span>) =&gt;</span> <span class="literal">undefined</span>)</span><br><span class="line">            .toPromise()</span><br><span class="line">            .then(fn);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		给当前redux中间件动态添加依赖(相当于createLogicMiddleware第二个参数的拓展)</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">  mw.addDeps = <span class="function"><span class="keyword">function</span> <span class="title">addDeps</span>(<span class="params">additionalDeps</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//	所添加的依赖必须是一个对象类型</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> additionalDeps !== <span class="string">'object'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'addDeps should be called with an object'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	遍历所添加的中间件</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(additionalDeps).forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> existing = deps[k];</span><br><span class="line">      <span class="keyword">const</span> newValue = additionalDeps[k];</span><br><span class="line">		<span class="comment">//	所添加的中间件不能和当前已有的重名(当前已经有的不能被覆盖)</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> existing !== <span class="string">'undefined'</span> &amp;&amp;</span><br><span class="line">          existing !== newValue) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`addDeps cannot override an existing dep value: <span class="subst">$&#123;k&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      deps[k] = newValue;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		给当前redux中间件动态添加新的logic</span></span><br><span class="line"><span class="comment">		@param arrNewLogic Array.&lt;Logic&gt;</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">  mw.addLogic = <span class="function"><span class="keyword">function</span> <span class="title">addLogic</span>(<span class="params">arrNewLogic</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!arrNewLogic.length) &#123; <span class="keyword">return</span> &#123; logicCount &#125;; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	合并到当前已有的数组里面</span></span><br><span class="line">    <span class="keyword">const</span> combinedLogic = savedLogicArr.concat(arrNewLogic);</span><br><span class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(combinedLogic);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	判断是否有重复</span></span><br><span class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</span><br><span class="line">          applyLogic(arrNewLogic, savedStore, savedNext,</span><br><span class="line">                     logicSub, actionEnd$, deps, logicCount, monitor$);</span><br><span class="line">    actionEnd$ = action$;</span><br><span class="line">    logicSub = sub;</span><br><span class="line">    logicCount = cnt;</span><br><span class="line">    savedLogicArr = combinedLogic;</span><br><span class="line">    debug(<span class="string">'added logic'</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">logicCount</span>: cnt &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		给当前redux中间件合并新的logic</span></span><br><span class="line"><span class="comment">		@param arrNewLogic Array.&lt;Logic&gt;</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">  mw.mergeNewLogic = <span class="function"><span class="keyword">function</span> <span class="title">mergeNewLogic</span>(<span class="params">arrMergeLogic</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 判断是否重名</span></span><br><span class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(arrMergeLogic);</span><br><span class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤掉重复的</span></span><br><span class="line">    <span class="keyword">const</span> arrNewLogic = arrMergeLogic.filter(<span class="function"><span class="params">x</span> =&gt;</span></span><br><span class="line">      savedLogicArr.indexOf(x) === <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> mw.addLogic(arrNewLogic);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">	替换当前所有的logic变成新的logic</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  mw.replaceLogic = <span class="function"><span class="keyword">function</span> <span class="title">replaceLogic</span>(<span class="params">arrRepLogic</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> duplicateLogic = findDuplicates(arrRepLogic);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	判断新的logic数组里是否有重复的logic</span></span><br><span class="line">    <span class="keyword">if</span> (duplicateLogic.length) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`duplicate logic, indexes: <span class="subst">$&#123;duplicateLogic&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; action$, sub, <span class="attr">logicCount</span>: cnt &#125; =</span><br><span class="line">          applyLogic(arrRepLogic, savedStore, savedNext,</span><br><span class="line">                     logicSub, actionSrc$, deps, <span class="number">0</span>, monitor$);</span><br><span class="line">    actionEnd$ = action$;</span><br><span class="line">    logicSub = sub;</span><br><span class="line">    logicCount = cnt;</span><br><span class="line">    savedLogicArr = arrRepLogic;</span><br><span class="line">    debug(<span class="string">'replaced logic'</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">logicCount</span>: cnt &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mw;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的分析中我们可以看出, <code>createLogicMiddleware</code>返回了一个中间件, 该中间件基于<a href="https://cn.rx.js.org/" target="_blank" rel="noopener">Rxjs</a>实现, 返回的中间件中处理相关<code>redux action</code>对应的逻辑。</p>
<p>在<code>createLogicMiddleware</code>中调用了一些其他函数, 逐个看下这些函数的实现:</p>
<p><code>findDuplicates</code>, 该方法完成查找数组里面重复的<code>Logic</code>, 并记录重复的下标返回</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	@param arrLogic  Array.&lt;Logic&gt;   logic数组</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param  &#123;Array.&lt;Logic&gt;&#125;  arrLogic Logic数组</span></span><br><span class="line"><span class="comment"> * @return &#123;Array.&lt;Number&gt;&#125;          重复的Logic下标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findDuplicates</span>(<span class="params">arrLogic</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arrLogic.reduce(<span class="function">(<span class="params">acc, x1, idx1</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//  不是同一个下标, 且值相等的情况下就把下标放到acc里面</span></span><br><span class="line">    <span class="keyword">if</span> (arrLogic.some(<span class="function">(<span class="params">x2, idx2</span>) =&gt;</span> (idx1 !== idx2 &amp;&amp; x1 === x2))) &#123;</span><br><span class="line">      acc.push(idx1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> acc;</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看看看<code>applyLogic</code>的实现:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param  &#123;Array.&lt;Logic&gt;&#125;   arrLogic        Logic数组</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;         store            redux store</span></span><br><span class="line"><span class="comment"> * @param  &#123;Function&#125;       next             redux中间件中的第二层函数</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     sub              当前action对应的</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     actionIn$        当前action对应的可订阅对象</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;         deps             createLogicMiddle的第二个参数</span></span><br><span class="line"><span class="comment"> * @param  &#123;Number&#125;         startLogicCount  用于命名</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125;     monitor$         全局可订阅对象</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyLogic</span>(<span class="params">arrLogic, store, next, sub, actionIn$, deps, startLogicCount, monitor$</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!store || !next) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'store is not defined'</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  如果当前Logic已经是一个Rx.Subject(已经被订阅过了), 取消订阅</span></span><br><span class="line">    <span class="keyword">if</span> (sub) &#123; sub.unsubscribe(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  对当前Logic数组进行操作(命名等), 返回一个新数组</span></span><br><span class="line">    <span class="keyword">const</span> wrappedLogic = arrLogic.map(<span class="function">(<span class="params">logic, idx</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//  给当前未指定name的Logic进行命名并且返回, naming稍候分析</span></span><br><span class="line">        <span class="keyword">const</span> namedLogic = naming(logic, idx + startLogicCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  包装命名后的Logic, wrapper稍候分析</span></span><br><span class="line">        <span class="keyword">return</span> wrapper(namedLogic, store, deps, monitor$);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> actionOut$ = wrappedLogic.reduce(<span class="function">(<span class="params">acc$, wep</span>) =&gt;</span> wep(acc$), actionIn$);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  订阅新的Observable对象</span></span><br><span class="line">    <span class="keyword">const</span> newSub = actionOut$.subscribe(<span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">        debug(<span class="string">'actionEnd$'</span>, action);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> result = next(action);</span><br><span class="line">            debug(<span class="string">'result'</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">'error in mw dispatch or next call, probably in middlware/reducer/render fn:'</span>, err);</span><br><span class="line">            <span class="keyword">const</span> msg = (err &amp;&amp; err.message) ? err.message : err;</span><br><span class="line">            monitor$.next(&#123; action, <span class="attr">err</span>: msg, <span class="attr">op</span>: <span class="string">'nextError'</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//  action变成了一个被转换后的新action</span></span><br><span class="line">        monitor$.next(&#123; <span class="attr">nextAction</span>: action, <span class="attr">op</span>: <span class="string">'bottom'</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        action$: actionOut$,</span><br><span class="line">        sub: newSub,</span><br><span class="line">        logicCount: startLogicCount + arrLogic.length</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的分析中我们可以看出, <code>applyLogic</code>返回了一个新的<a href="https://cn.rx.js.org/class/es6/Observable.js~Observable.html" target="_blank" rel="noopener">Rx.Observable</a>, 里面调用了<code>naming</code>和<code>wrapper</code>, 下面我们逐个分析下。</p>
<p>先看<code>naming</code>的实现吧:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断当前传入的Logic有没有name, 有就不做任何操作直接返回, 没有就给当前Logic添加一个name属性后返回</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125; logic 当前Logic</span></span><br><span class="line"><span class="comment"> * @param  &#123;Number&#125; idx   当前Logic在arrLogic中的下标地址</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">naming</span>(<span class="params">logic, idx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logic.name) &#123; <span class="keyword">return</span> logic; &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...logic,</span><br><span class="line">        name: <span class="string">`L(<span class="subst">$&#123;logic.type.toString()&#125;</span>)-<span class="subst">$&#123;idx&#125;</span>`</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看下<code>wrapper</code>的, <code>wrapper</code>是写在<code>src/logicWrapper</code>里的, <code>wrapper</code>返回的是一个<code>Rx.Observable</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Logic中相关处理</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.action   当前action</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.logic    当前logic</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.store    redux store</span></span><br><span class="line"><span class="comment"> * @param  &#123;Object&#125;     options.deps     createLogicMiddleware的第二个参数</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125; options.cancel$  取消Logic执行的订阅对象</span></span><br><span class="line"><span class="comment"> * @param  &#123;Rx.Subject&#125; options.monitor$ 全局可订阅对象</span></span><br><span class="line"><span class="comment"> * @return &#123;Rx.Observable&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createLogicAction$</span>(<span class="params">&#123; action, logic, store, deps, cancel$, monitor$ &#125;</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  reduxStore.getState()</span></span><br><span class="line">    <span class="keyword">const</span> &#123; getState &#125; = store;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  从当前logic中取得相关配置参数</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        name,</span><br><span class="line">        warnTimeout,</span><br><span class="line">        process: processFn,</span><br><span class="line">        processOptions: &#123;</span><br><span class="line">            dispatchReturn,</span><br><span class="line">            dispatchMultiple,</span><br><span class="line">            successType,</span><br><span class="line">            failType</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; = logic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  当前Logic的拦截器</span></span><br><span class="line">    <span class="keyword">const</span> intercept = logic.validate || logic.transform;</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">'createLogicAction$'</span>, name, action);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  开始本次action的执行</span></span><br><span class="line">    monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'begin'</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        1.当前action发生改变</span></span><br><span class="line"><span class="comment">        2.在validate/transform中调用allow</span></span><br><span class="line"><span class="comment">        3.无效的action type</span></span><br><span class="line"><span class="comment">        4.action被取消</span></span><br><span class="line"><span class="comment">        interceptComplete都会变成true, 标记拦截器处理完成</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">let</span> interceptComplete = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-take</span></span><br><span class="line">    <span class="keyword">const</span> logicAction$ = Observable.create(<span class="function"><span class="params">logicActionObs</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//  创建一个主题(只发出一个值), 用来订阅`取消Logic执行的订阅对象`, 在取消本次action后, 通知`取消Logic执行的订阅对象`</span></span><br><span class="line">            <span class="keyword">const</span> cancelled$ = (<span class="keyword">new</span> Subject()).take(<span class="number">1</span>);</span><br><span class="line">            cancel$.subscribe(cancelled$);</span><br><span class="line">            cancelled$</span><br><span class="line">                .subscribe(</span><br><span class="line">                    () =&gt; &#123;</span><br><span class="line">                        <span class="comment">//  确保cancel不会被调用2次(在createLogicMiddle中追加的pending只会被减一次)</span></span><br><span class="line">                        <span class="keyword">if</span> (!interceptComplete) &#123;</span><br><span class="line">                            monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'cancelled'</span> &#125;);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'dispCancelled'</span> &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  如果当前Logic不是一个持续性的, 且没有在warnTimeout / 1000秒内调用done(warnTimeout &gt; 0), 就给出异常提示</span></span><br><span class="line">            <span class="keyword">if</span> (NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warnTimeout) &#123;</span><br><span class="line">                Observable.timer(warnTimeout)</span><br><span class="line">                    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-takeUntil</span></span><br><span class="line">                    <span class="comment">//  https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-defaultIfEmpty</span></span><br><span class="line">                    .takeUntil(cancelled$.defaultIfEmpty(<span class="literal">true</span>))</span><br><span class="line">                    .do(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//	console.error(`warning: logic ($&#123;name&#125;) is still running after $&#123;warnTimeout / 1000&#125;s, forget to call done()? For non-ending logic, set warnTimeout: 0`);</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                    .subscribe();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> dispatch$ = (<span class="keyword">new</span> Subject())</span><br><span class="line">                .mergeAll()</span><br><span class="line">                .takeUntil(cancel$);</span><br><span class="line"></span><br><span class="line">            dispatch$</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                    .do(&#123;</span></span><br><span class="line"><span class="comment">                        nextOrObserver: mapToActionAndDispatch,</span></span><br><span class="line"><span class="comment">                        error: mapErrorToActionAndDispatch</span></span><br><span class="line"><span class="comment">                    &#125;)</span></span><br><span class="line"><span class="comment">                    这里省略了nextOrObserver和error</span></span><br><span class="line"><span class="comment">                    https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-do</span></span><br><span class="line"><span class="comment">                 **/</span></span><br><span class="line">                .do(</span><br><span class="line">                    mapToActionAndDispatch,</span><br><span class="line">                    mapErrorToActionAndDispatch</span><br><span class="line">                )</span><br><span class="line">                .subscribe(&#123;</span><br><span class="line">                    error: <span class="function">(<span class="params"> <span class="regexp">/* err */</span> </span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//  在发生异常后, 终止本次acion, 并且取消订阅cancelled$</span></span><br><span class="line">                        monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'end'</span> &#125;);</span><br><span class="line">                        cancelled$.complete();</span><br><span class="line">                        cancelled$.unsubscribe();</span><br><span class="line">                    &#125;,</span><br><span class="line">                    complete: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="comment">//  本次action处理完成</span></span><br><span class="line">                        monitor$.next(&#123; action, name, <span class="attr">op</span>: <span class="string">'end'</span> &#125;);</span><br><span class="line">                        cancelled$.complete();</span><br><span class="line">                        cancelled$.unsubscribe();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  触发redux里面的action</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">storeDispatch</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                monitor$.next(&#123; action, <span class="attr">dispAction</span>: act, <span class="attr">op</span>: <span class="string">'dispatch'</span> &#125;);</span><br><span class="line">                <span class="keyword">return</span> store.dispatch(act);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 适配不同情况的action, 组装后如果是一个有效的redux action, 就调用reduxStore.dispatch</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; actionOrValue</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapToActionAndDispatch</span>(<span class="params">actionOrValue</span>) </span>&#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                    let act;</span></span><br><span class="line"><span class="comment">                    if (isInterceptAction(actionOrValue)) &#123;</span></span><br><span class="line"><span class="comment">                        act = unwrapInterceptAction(actionOrValue);</span></span><br><span class="line"><span class="comment">                    &#125; else &#123;</span></span><br><span class="line"><span class="comment">                        if (successType) &#123;</span></span><br><span class="line"><span class="comment">                            act = mapToAction(successType, actionOrValue, false);</span></span><br><span class="line"><span class="comment">                        &#125; else &#123;</span></span><br><span class="line"><span class="comment">                            act = actionOrValue;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                    把下面的代码拆成上面的样子, 大概做了下面几件事情:</span></span><br><span class="line"><span class="comment">                    判断是不是一个拦截器, 如果是就把之前包装的拦截器解包</span></span><br><span class="line"><span class="comment">                    判断processOptions.successType是否存在, 存在就调用mapToAction, 拼出一个新的redux action, 调用reduxSrore.dispatch</span></span><br><span class="line"><span class="comment">                    否则就直接使用actionOrValue</span></span><br><span class="line"><span class="comment">                **/</span></span><br><span class="line">                <span class="keyword">const</span> act = (isInterceptAction(actionOrValue)) ? </span><br><span class="line">                unwrapInterceptAction(actionOrValue) : (successType) ? </span><br><span class="line">                mapToAction(successType, actionOrValue, <span class="literal">false</span>) : actionOrValue;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                    storeDispatch(act);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 根据actionOrValue的类型来组装可以被reduxStore.dispatch调用的action</span></span><br><span class="line"><span class="comment">             * @param  &#123;any&#125; actionOrValue</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapErrorToActionAndDispatch</span>(<span class="params">actionOrValue</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  拦截器类型的直接调用触发__interceptAction</span></span><br><span class="line">                <span class="keyword">if</span> (isInterceptAction(actionOrValue)) &#123;</span><br><span class="line">                    <span class="keyword">const</span> interceptAction = unwrapInterceptAction(actionOrValue);</span><br><span class="line">                    <span class="keyword">return</span> storeDispatch(interceptAction);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  判断Logic中的processOptions里有没有failType</span></span><br><span class="line">                <span class="keyword">if</span> (failType) &#123;</span><br><span class="line">                    <span class="comment">//  如果有failType, 组装一个新的redux action并触发</span></span><br><span class="line">                    <span class="keyword">const</span> act = mapToAction(failType, actionOrValue, <span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                        <span class="keyword">return</span> storeDispatch(act);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  actionOrValue本身就是一个异常</span></span><br><span class="line">                <span class="keyword">if</span> (actionOrValue <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> act =</span><br><span class="line">                        <span class="comment">//  actionOrValue本身包含type, 直接调用redux.dispatch(actionOrValue)</span></span><br><span class="line">                        <span class="comment">//  否则包装出一个redux action(type为UNHANDLED_LOGIC_ERROR), 在调用redux.dispatch</span></span><br><span class="line">                        (actionOrValue.type) ? actionOrValue :</span><br><span class="line">                        &#123;</span><br><span class="line">                            type: UNHANDLED_LOGIC_ERROR,</span><br><span class="line">                            payload: actionOrValue,</span><br><span class="line">                            error: <span class="literal">true</span></span><br><span class="line">                        &#125;;</span><br><span class="line">                    <span class="keyword">return</span> storeDispatch(act);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  actionOrValue是一个plain object或一个函数(action creator)</span></span><br><span class="line">                <span class="keyword">const</span> typeOfValue = <span class="keyword">typeof</span> actionOrValue;</span><br><span class="line">                <span class="keyword">if</span> (actionOrValue &amp;&amp; (typeOfValue === <span class="string">'object'</span> || typeOfValue === <span class="string">'function'</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> storeDispatch(actionOrValue);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  非异常/函数/plain object的情况</span></span><br><span class="line">                storeDispatch(&#123;</span><br><span class="line">                    type: UNHANDLED_LOGIC_ERROR,</span><br><span class="line">                    payload: actionOrValue,</span><br><span class="line">                    error: <span class="literal">true</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 组装出一个有效的redux action并返回</span></span><br><span class="line"><span class="comment">             * @param  &#123;String|Function&#125; type       redux action type</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; payload             redux payload</span></span><br><span class="line"><span class="comment">             * @param  &#123;Error|Unfdeined&#125; err        error</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">mapToAction</span>(<span class="params">type, payload, err</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  action type本身是一个action creator, 直接执行type</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> type(payload);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//  包装出一个有效的redux action</span></span><br><span class="line">                <span class="keyword">const</span> act = &#123; type, payload &#125;;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123; act.error = <span class="literal">true</span>; &#125;</span><br><span class="line">                <span class="keyword">return</span> act;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// allowMore is now deprecated in favor of variable process arity</span></span><br><span class="line">            <span class="comment">// which sets processOptions.dispatchMultiple = true then</span></span><br><span class="line">            <span class="comment">// expects done() cb to be called to end</span></span><br><span class="line">            <span class="comment">// Might still be needed for internal use so keeping it for now</span></span><br><span class="line">            <span class="keyword">const</span> DispatchDefaults = &#123;</span><br><span class="line">                allowMore: <span class="literal">false</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 触发</span></span><br><span class="line"><span class="comment">             * @param  &#123;[type]&#125; act     [description]</span></span><br><span class="line"><span class="comment">             * @param  &#123;[type]&#125; options [description]</span></span><br><span class="line"><span class="comment">             * @return &#123;[type]&#125;         [description]</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">act, options = DispatchDefaults</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; allowMore &#125; = applyDispatchDefaults(options);</span><br><span class="line">                <span class="comment">//  action !== undefined</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> act !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                        let action;</span></span><br><span class="line"><span class="comment">                        if (isObservable(act)) &#123;</span></span><br><span class="line"><span class="comment">                            action = act;</span></span><br><span class="line"><span class="comment">                        &#125; else if (isPromise(act)) &#123;</span></span><br><span class="line"><span class="comment">                            action = Observable.fromPromise(act);</span></span><br><span class="line"><span class="comment">                        &#125; else if (act instanceof Error) &#123;</span></span><br><span class="line"><span class="comment">                            action = Observable.throw(act);</span></span><br><span class="line"><span class="comment">                        &#125; else &#123;</span></span><br><span class="line"><span class="comment">                            action = Observable.of(act);</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                        dispatch$.next(action);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                        https://cn.rx.js.org/class/es6/MiscJSDoc.js~ObserverDoc.html#instance-method-next</span></span><br><span class="line"><span class="comment">                     **/</span></span><br><span class="line">                    dispatch$.next(</span><br><span class="line">                        (isObservable(act)) ? act :</span><br><span class="line">                        (isPromise(act)) ? Observable.fromPromise(act) :</span><br><span class="line">                        (act <span class="keyword">instanceof</span> <span class="built_in">Error</span>) ? Observable.throw(act) :</span><br><span class="line">                        Observable.of(act)</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!(dispatchMultiple || allowMore)) &#123;</span><br><span class="line">                   dispatch$.complete();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> act;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">applyDispatchDefaults</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...DispatchDefaults,</span><br><span class="line">                    ...options</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  拼装createLogic中相关钩子函数(validate/tranform/process)中的第一个参数</span></span><br><span class="line">            <span class="keyword">const</span> depObj = &#123;</span><br><span class="line">                ...deps,</span><br><span class="line">                cancelled$,</span><br><span class="line">                ctx: &#123;&#125;, <span class="comment">// 在不同钩子中共享数据</span></span><br><span class="line">                getState,</span><br><span class="line">                action</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">shouldDispatch</span>(<span class="params">act, useDispatch</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  新的action为空</span></span><br><span class="line">                <span class="keyword">if</span> (!act) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">                <span class="comment">//  在触发另外一个action之前, 确保触发的是一个新的action</span></span><br><span class="line">                <span class="keyword">if</span> (useDispatch === <span class="string">'auto'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> (act.type !== action.type);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//  否则根据useDispatch是否为空, 返回</span></span><br><span class="line">                <span class="keyword">return</span> (useDispatch);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> AllowRejectNextDefaults = &#123;</span><br><span class="line">                useDispatch: <span class="string">'auto'</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">applyAllowRejectNextDefaults</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    ...AllowRejectNextDefaults,</span><br><span class="line">                    ...options</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  拦截器(validate/tranform)里的allow或next</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">allow</span>(<span class="params">act, options = AllowRejectNextDefaults</span>) </span>&#123;</span><br><span class="line">                handleNextOrDispatch(<span class="literal">true</span>, act, options);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">reject</span>(<span class="params">act, options = AllowRejectNextDefaults</span>) </span>&#123;</span><br><span class="line">                handleNextOrDispatch(<span class="literal">false</span>, act, options);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  完成本次action, 在createLogic中的process最后调用</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">done</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                dispatch$.complete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 对当前拦截器类型action(validate/transform)做一次包装, 方便后面判断</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; act 当前action</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">wrapActionForIntercept</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!act) &#123; <span class="keyword">return</span> act; &#125;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    __interceptAction: act</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 判断传入的action是否为拦截器类型的</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125;  act 当前action</span></span><br><span class="line"><span class="comment">             * @return &#123;Boolean&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">isInterceptAction</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> act &amp;&amp; act.__interceptAction;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 对拦截器执行解包</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125;  act 当前action</span></span><br><span class="line"><span class="comment">             * @return &#123;Object&#125;      redux action</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">unwrapInterceptAction</span>(<span class="params">act</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> act.__interceptAction;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 拦截器(validate/tranform)里的allow、reject实现, 触发新的redux action</span></span><br><span class="line"><span class="comment">             * @param  &#123;Boolean&#125; shouldProcess 是否执行process</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; act            新的redux action</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; options</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">handleNextOrDispatch</span>(<span class="params">shouldProcess, act, options</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; useDispatch &#125; = applyAllowRejectNextDefaults(options);</span><br><span class="line">                <span class="comment">//  判断是否应该触发传入的redux action</span></span><br><span class="line">                <span class="keyword">if</span> (shouldDispatch(act, useDispatch)) &#123;</span><br><span class="line">                    monitor$.next(&#123; action, <span class="attr">dispAction</span>: act, name, shouldProcess, <span class="attr">op</span>: <span class="string">'nextDisp'</span> &#125;);</span><br><span class="line">                    interceptComplete = <span class="literal">true</span>;</span><br><span class="line">                    dispatch(wrapActionForIntercept(act), &#123; <span class="attr">allowMore</span>: <span class="literal">true</span> &#125;); <span class="comment">// will be completed later</span></span><br><span class="line">                    logicActionObs.complete(); <span class="comment">// dispatched action, so no next(act)</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// normal next</span></span><br><span class="line">                    <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                        monitor$.next(&#123; action, <span class="attr">nextAction</span>: act, name, shouldProcess, <span class="attr">op</span>: <span class="string">'next'</span> &#125;);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//  无效的action, 直接结束本次拦截器</span></span><br><span class="line">                        monitor$.next(&#123; action, name, shouldProcess, <span class="attr">op</span>: <span class="string">'filtered'</span> &#125;);</span><br><span class="line">                        interceptComplete = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    postIfDefinedOrComplete(act, logicActionObs);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  执行Logic中的process回调</span></span><br><span class="line">                <span class="keyword">if</span> (shouldProcess) &#123;</span><br><span class="line">                    <span class="comment">//  组织depObj的action参数</span></span><br><span class="line">                    depObj.action = act || action;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">const</span> retValue = processFn(depObj, dispatch, done);</span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                            如果在createLogic指定了processOption.dispatchReturn为true, 并且prcess执行完之后返回有效的值</span></span><br><span class="line"><span class="comment">                            就再把返回值作为一个新的redux action进行触发</span></span><br><span class="line"><span class="comment">                            否则直接结束dispatch$这个Rx.Subject</span></span><br><span class="line"><span class="comment">                            </span></span><br><span class="line"><span class="comment">                            执行process, 并且接收返回值</span></span><br><span class="line"><span class="comment">                            判断processOption.dispatchReturn</span></span><br><span class="line"><span class="comment">                                成立: 判断返回值是否有效</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                                    有效: dispatch -&gt; mapToActionAndDispatch</span></span><br><span class="line"><span class="comment">                                        mapToActionAndDispatch返回一个有效的action:</span></span><br><span class="line"><span class="comment">                                            继续reduxStore.dispatch(mapToActionAndDispatch(retValue))</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                                    无效: dispatch$.complete -&gt; monitor$.next(&#123; action, name, op: 'end' &#125;); cancelled$.complete(); cancelled$.unsubscribe();</span></span><br><span class="line"><span class="comment">                        **/</span></span><br><span class="line">                        <span class="keyword">if</span> (dispatchReturn) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">typeof</span> retValue === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                                dispatch$.complete();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                dispatch(retValue);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.error(<span class="string">`unhandled exception in logic named: <span class="subst">$&#123;name&#125;</span>`</span>, err);</span><br><span class="line">                        <span class="comment">//  执行process的过程中发生异常</span></span><br><span class="line">                        dispatch(Observable.throw(err));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//  传入的act是一个空值, 或者和当前的type相同, 或者useDispatch不成立</span></span><br><span class="line">                    dispatch$.complete();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 在本次拦截器之后执行</span></span><br><span class="line"><span class="comment">             * @param  &#123;Object&#125; act       新的action</span></span><br><span class="line"><span class="comment">             * @param  &#123;Rx.Subject&#125; act$  当前action对应的Observable对象</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">postIfDefinedOrComplete</span>(<span class="params">act, act$</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//  如果新的action存在, 执行新的action</span></span><br><span class="line">                <span class="keyword">if</span> (act) &#123;</span><br><span class="line">                    act$.next(act);</span><br><span class="line">                &#125;</span><br><span class="line">                interceptComplete = <span class="literal">true</span>;</span><br><span class="line">                act$.complete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//  开始本次action的执行</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                intercept(depObj, allow, reject);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            start();</span><br><span class="line">        &#125;)</span><br><span class="line">        .takeUntil(cancel$)</span><br><span class="line">        <span class="comment">//  规定logicAction$值发出一个值就完成</span></span><br><span class="line">        .take(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> logicAction$;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上就是本人对<code>redux-logic</code>的阅读, 经过阅读, 大致了解到整个<code>redux-logic</code>的执行顺序应该是下图所示的样子。</p>
<p><img src="/imgs/redux-logic.png" alt></p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/09/28/2019-09-28-react-binding-events-with-arguments/" class="prev">PREV</a><a href="/2017/11/09/2017-11-09-vue-computed/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://yoursite.com">rwson</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>